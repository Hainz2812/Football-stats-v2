<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Match Oracle"/>
<meta name="theme-color" content="#000"/>
<title>Match Oracle</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#000;--s1:#0c0c0c;--b1:rgba(255,255,255,.08);--b2:rgba(255,255,255,.16);
  --Y:#ffe600;--B:#4db8ff;--B2:#1a9fff;--G:#39ff88;--O:#ff9a1f;--R:#ff4040;
  --t1:#fff;--t2:#aaa;--t3:#555;--mono:'Share Tech Mono',monospace;
}
html{-webkit-text-size-adjust:100%}
body{background:var(--bg);color:#fff;font-family:'Barlow Condensed',system-ui,sans-serif;
  min-height:100vh;overflow-x:hidden;padding:env(safe-area-inset-top,0) 0 env(safe-area-inset-bottom,20px);}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.05) 3px,rgba(0,0,0,.05) 4px);}
.topline{position:fixed;top:0;left:0;right:0;height:2px;z-index:1000;
  background:linear-gradient(90deg,transparent,var(--Y),transparent);
  box-shadow:0 0 22px 3px rgba(255,230,0,.45);}
.wrap{max-width:640px;margin:0 auto;padding:22px 14px 80px;position:relative;z-index:2}
header{text-align:center;margin-bottom:20px;padding-top:10px}
.hline{height:1px;background:linear-gradient(90deg,transparent,rgba(255,230,0,.4),transparent);margin-bottom:18px}
.logo-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:4px}
.logo-icon{width:40px;height:40px;background:var(--Y);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;
  clip-path:polygon(6px 0,calc(100% - 6px) 0,100% 6px,100% calc(100% - 6px),calc(100% - 6px) 100%,6px 100%,0 calc(100% - 6px),0 6px);
  box-shadow:0 0 30px rgba(255,230,0,.5);}
.site-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(42px,9vw,64px);letter-spacing:6px;line-height:1;color:#fff;}
.tagline{font-family:var(--mono);font-size:9px;letter-spacing:4px;color:var(--t3);text-transform:uppercase;
  margin-top:7px;padding-top:7px;border-top:1px solid var(--b1);}
.tagline .sep{color:var(--Y);margin:0 4px}
.card{background:var(--s1);border:1px solid var(--b1);border-radius:3px;padding:16px;margin-bottom:10px;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(77,184,255,.3),transparent);}
.slabel{font-family:var(--mono);font-size:9px;letter-spacing:3px;color:var(--t3);text-transform:uppercase;display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.slabel::after{content:'';flex:1;height:1px;background:var(--b1)}
input[type=password],input[type=date]{width:100%;background:rgba(0,0,0,.7);border:1px solid var(--b2);color:#fff;padding:13px 16px;font-size:16px;
  font-family:'Barlow Condensed',sans-serif;font-weight:600;outline:none;border-radius:3px;-webkit-appearance:none;appearance:none;}
input:focus{border-color:var(--Y);}
input[type=date]{color-scheme:dark}
input::placeholder{color:var(--t3)}
button{font-family:'Barlow Condensed',sans-serif;cursor:pointer;-webkit-appearance:none;appearance:none;touch-action:manipulation;border-radius:3px;}
.btn-primary{display:block;width:100%;border:none;padding:14px;font-size:16px;letter-spacing:3px;font-weight:700;text-transform:uppercase;
  margin-top:10px;min-height:50px;color:#000;background:var(--Y);box-shadow:0 4px 26px rgba(255,230,0,.32);}
.btn-primary:active{opacity:.85}
.btn-sm{background:transparent;border:1px solid var(--b2);color:var(--t2);font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:6px 12px;min-height:32px;}
.key-bar{display:flex;justify-content:space-between;align-items:center;background:rgba(57,255,136,.05);border:1px solid rgba(57,255,136,.18);
  border-radius:3px;padding:10px 16px;margin-bottom:10px;font-family:var(--mono);font-size:10px;color:var(--G);}
.key-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--G);margin-right:8px;box-shadow:0 0 8px var(--G);animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.date-bar{position:sticky;top:0;z-index:100;background:rgba(0,0,0,.96);border-bottom:1px solid var(--b1);
  padding:10px 0 8px;margin-bottom:14px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);}
.date-row{display:flex;gap:6px;align-items:stretch}
.date-row input{flex:1;min-width:0}
.btn-arr{background:rgba(255,255,255,.04);border:1px solid var(--b1);color:var(--t2);width:44px;min-height:46px;
  display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.btn-arr:active{background:rgba(255,230,0,.1);color:var(--Y)}
.btn-load{background:var(--B2);color:#fff;border:none;padding:0 16px;font-family:var(--mono);font-size:11px;letter-spacing:2px;
  min-height:46px;flex-shrink:0;text-transform:uppercase;}
.btn-load:active{opacity:.8}
.btn-load:disabled{opacity:.4;cursor:not-allowed}
.quick-dates{display:flex;gap:5px;margin-top:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.quick-dates::-webkit-scrollbar{display:none}
.qd-btn{background:rgba(255,255,255,.04);border:1px solid var(--b1);color:var(--t3);font-family:var(--mono);font-size:9px;letter-spacing:1px;
  padding:5px 10px;min-height:28px;white-space:nowrap;flex-shrink:0;text-transform:uppercase;}
.qd-btn.active{background:rgba(255,230,0,.1);border-color:rgba(255,230,0,.4);color:var(--Y)}
.prog-wrap{margin-bottom:12px;}
.prog-label{font-family:var(--mono);font-size:9px;color:var(--t3);letter-spacing:2px;text-align:center;margin-bottom:6px;text-transform:uppercase;}
.prog-track{height:2px;background:rgba(255,255,255,.06);border-radius:1px;overflow:hidden;}
.prog-fill{height:100%;background:var(--Y);border-radius:1px;transition:width .2s ease;}
.cached-note{font-family:var(--mono);font-size:9px;color:var(--G);letter-spacing:1px;text-align:center;
  padding:4px;margin-bottom:8px;opacity:.7;}
.day-summary{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:2px;text-align:center;padding:6px 0 10px;text-transform:uppercase;}
.day-summary b{color:#fff}
.league-group{margin-bottom:6px;animation:up .2s both;}
.lg-hdr{display:flex;align-items:center;gap:10px;padding:11px 14px;background:rgba(255,255,255,.03);
  border:1px solid var(--b1);border-radius:3px;cursor:pointer;user-select:none;-webkit-user-select:none;
  transition:background .15s;}
.lg-hdr:active{background:rgba(255,230,0,.06);}
.lg-hdr.open{border-radius:3px 3px 0 0;border-bottom:1px solid rgba(255,230,0,.15);}
.lg-flag{font-size:16px;flex-shrink:0;line-height:1}
.lg-name{font-size:13px;font-weight:700;color:var(--Y);letter-spacing:.5px;flex:1;}
.lg-count{font-family:var(--mono);font-size:9px;color:var(--t3);letter-spacing:1px;margin-right:4px;}
.lg-chevron{font-size:10px;color:var(--t3);flex-shrink:0;transition:transform .25s;line-height:1;}
.lg-hdr.open .lg-chevron{transform:rotate(180deg);}
.lg-body{display:none;flex-direction:column;overflow:hidden;}
.lg-body.open{display:flex;}

/* â”€â”€ FIXTURE + INLINE PANEL â”€â”€ */
.fx-wrap{display:flex;flex-direction:column;border:1px solid rgba(77,184,255,.35);border-radius:4px;
  margin-bottom:6px;overflow:hidden;box-shadow:0 0 12px rgba(77,184,255,.08);}
.fx-row{padding:10px 14px;background:rgba(77,184,255,.04);border-bottom:1px solid rgba(77,184,255,.15);
  position:relative;overflow:hidden;}
.fx-teams{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:5px;}
.fx-team{display:flex;align-items:center;gap:6px;flex:1;min-width:0;}
.fx-team.r{justify-content:flex-end;}
.fx-team img{width:20px;height:20px;object-fit:contain;flex-shrink:0;}
.fx-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#fff;}
.fx-score{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--Y);
  padding:1px 9px;background:rgba(255,230,0,.06);border:1px solid rgba(255,230,0,.14);flex-shrink:0;letter-spacing:2px;border-radius:3px;}
.fx-status{font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:2px 7px;border-radius:2px;}

/* â”€â”€ PREDICTION STRIP â”€â”€ */
.fp-strip{display:flex;align-items:center;flex-wrap:wrap;gap:3px 8px;
  padding:6px 14px;border-top:1px solid rgba(255,230,0,.08);background:rgba(255,230,0,.015);}
.fp-pred{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:1.5px;flex-shrink:0;line-height:1;}
.fp-div{color:var(--t3);font-size:9px;flex-shrink:0;}
.fp-h{font-family:var(--mono);font-size:10px;font-weight:700;color:#4db8ff;flex-shrink:0;}
.fp-d{font-family:var(--mono);font-size:10px;font-weight:700;color:#ffe600;flex-shrink:0;}
.fp-a{font-family:var(--mono);font-size:10px;font-weight:700;color:#ff9a1f;flex-shrink:0;}
.fp-verdict{font-family:var(--mono);font-size:9px;font-weight:700;flex-shrink:0;letter-spacing:.5px;}
.fp-h2h{font-family:var(--mono);font-size:9px;color:var(--t2);flex-shrink:0;letter-spacing:.5px;}
.fp-value{font-family:var(--mono);font-size:9px;font-weight:700;flex-shrink:0;letter-spacing:.5px;
  padding:2px 6px;border-radius:2px;border:1px solid currentColor;}
.fp-odds-row{display:flex;align-items:center;flex-wrap:wrap;gap:4px 10px;
  padding:5px 14px 7px;border-top:1px solid rgba(255,255,255,.04);}
.fp-odds-item{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;}
.fp-odds-label{color:var(--t3);letter-spacing:1px;text-transform:uppercase;}
.fp-odds-price{color:#fff;font-weight:700;}
.fp-odds-edge{font-weight:700;font-size:9px;}

/* â”€â”€ STATS TABLE â”€â”€ */
.fp-tbl{width:100%;border-collapse:collapse;border-top:1px solid rgba(255,255,255,.05);}
.fp-tbl th{font-family:var(--mono);font-size:8px;color:var(--Y);letter-spacing:1px;text-transform:uppercase;
  padding:5px 6px;text-align:center;background:rgba(255,230,0,.05);font-weight:700;}
.fp-tbl th:first-child{text-align:left;padding-left:14px;}
.fp-tbl th:last-child{padding-right:14px;}
.fp-tbl td{padding:7px 6px;text-align:center;border-top:1px solid rgba(255,255,255,.03);}
.fp-tbl td:first-child{padding-left:14px;text-align:left;}
.fp-tbl td:last-child{padding-right:14px;}
.fp-tbl tr:last-child td{padding-bottom:10px;}
.td-team{display:flex;align-items:center;gap:6px;}
.td-team img{width:16px;height:16px;object-fit:contain;flex-shrink:0;}
.td-team span{font-size:11px;font-weight:700;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:90px;}
.td-val{font-family:'Bebas Neue',sans-serif;font-size:17px;line-height:1;display:block;}
.td-sub{font-family:var(--mono);font-size:7px;color:var(--t3);display:block;margin-top:1px;}

.filter-bar{display:flex;gap:6px;flex-wrap:wrap;padding:8px 0 4px;margin-bottom:6px;}
.f-btn{background:rgba(255,255,255,.04);border:1px solid var(--b1);color:var(--t3);
  font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:5px 11px;min-height:28px;
  text-transform:uppercase;flex-shrink:0;transition:all .15s;}
.f-btn.on{border-color:currentColor;opacity:1;}
.f-btn.off{opacity:.35;}
.f-btn[data-conf="Strong Signal"].on{color:#39ff88;background:rgba(57,255,136,.08);}
.f-btn[data-conf="Good Edge"].on{color:#ffe600;background:rgba(255,230,0,.08);}
.f-btn[data-conf="Slight Edge"].on{color:#ff9a1f;background:rgba(255,154,31,.08);}
.f-btn[data-conf="Too Close"].on{color:#ff4040;background:rgba(255,64,64,.08);}
.f-btn[data-conf="all"].on{color:#fff;background:rgba(255,255,255,.06);}
.f-btn[data-value="1"].on{color:#39ff88;background:rgba(57,255,136,.1);border-color:#39ff88;}
.f-btn[data-value="1"].off{opacity:.35;}
.no-fx{text-align:center;font-family:var(--mono);color:var(--t3);font-size:11px;padding:36px 20px;letter-spacing:2px;text-transform:uppercase;line-height:2;}
.err-box{padding:14px;background:rgba(255,64,64,.05);border:1px solid rgba(255,64,64,.2);margin-bottom:10px;border-radius:3px;}
.err-title{font-family:var(--mono);color:var(--R);font-size:10px;letter-spacing:2px;margin-bottom:6px;}
.err-body{color:rgba(255,150,150,.9);font-size:12px;line-height:1.6;font-family:var(--mono);word-break:break-all;}
.install-hint{background:rgba(77,184,255,.05);border:1px solid rgba(77,184,255,.15);border-radius:3px;padding:9px 14px;margin-bottom:12px;
  font-family:var(--mono);font-size:9px;color:var(--t3);line-height:1.7;text-align:center;letter-spacing:1px;}
.install-hint strong{color:var(--Y)}
.hidden{display:none!important}

.debug-toggle{background:rgba(255,230,0,.12);border:1px solid rgba(255,230,0,.3);color:var(--Y);
  font-family:var(--mono);font-size:9px;font-weight:700;padding:5px 12px;
  letter-spacing:1px;cursor:pointer;margin:8px 0 4px;border-radius:3px;}
.debug-panel{background:rgba(0,0,0,.95);border:1px solid rgba(255,230,0,.2);border-radius:3px;
  max-height:50vh;overflow-y:auto;padding:10px 14px;margin-bottom:8px;
  font-family:var(--mono);font-size:10px;color:#0f0;line-height:1.7;
  white-space:pre-wrap;word-break:break-all;}
@keyframes up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.fadein{animation:up .2s both;}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:.8}}
.pulsing{animation:pulse 1.4s ease-in-out infinite;}

/* Landscape */
@media(orientation:landscape) and (max-height:500px){
  .wrap{padding-top:6px;padding-bottom:30px;}
  header{margin-bottom:8px;padding-top:2px;}
  .site-title{font-size:32px;}
  .tagline{display:none;}
  .date-bar{padding:5px 0 4px;}
  .quick-dates{display:none;}
}
</style>
</head>
<body>
<div class="topline"></div>
<div class="wrap">

<div class="install-hint" id="install-hint">
  ğŸ“± <strong>Add to Home Screen</strong> Â· tap Share in Safari â†’ "Add to Home Screen"
</div>

<header>
  <div class="hline"></div>
  <div class="logo-row">
    <div class="logo-icon">âš½</div>
    <span class="site-title">Match Oracle</span>
  </div>
  <p class="tagline">Poisson<span class="sep">â—†</span>Venue Form<span class="sep">â—†</span>Last 5 Games</p>
</header>

<div id="key-section" class="card">
  <span class="slabel">API-Football Key</span>
  <input type="password" id="api-key-input" placeholder="Paste your API-Football key here"
    autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"/>
  <span class="slabel" style="margin-top:10px">The Odds API Key <span style="color:var(--t3);font-size:10px">(optional â€” live odds for strong/good edge fixtures)</span></span>
  <input type="password" id="odds-api-key-input" placeholder="Paste your Odds API key here (optional)"
    autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"/>
  <button class="btn-primary" id="save-key-btn">Unlock Match Oracle</button>
</div>

<div id="key-bar" class="key-bar hidden">
  <span><span class="key-dot"></span>Connected Â· API Key Active</span>
  <button class="btn-sm" id="change-key-btn">Change Key</button>
</div>

<div id="main-app" class="hidden">
  <div class="date-bar">
    <div class="date-row">
      <button class="btn-arr" id="prev-day">&#9664;</button>
      <input type="date" id="date-input"/>
      <button class="btn-arr" id="next-day">&#9654;</button>
      <button class="btn-load" id="load-btn">Load</button>
    </div>
    <div class="quick-dates" id="quick-dates"></div>
  </div>

  <div id="prog-wrap" class="prog-wrap hidden">
    <div class="prog-label" id="prog-label">Loading...</div>
    <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>

  <div id="cached-note" class="cached-note hidden">âš¡ Loaded from cache</div>

  <div id="main-error" class="err-box hidden">
    <div class="err-title">&#9888; Error</div>
    <div class="err-body" id="main-error-body"></div>
  </div>

  <div id="filter-bar" class="filter-bar hidden">
    <button class="f-btn on" data-conf="all">All</button>
    <button class="f-btn on" data-conf="Strong Signal">Strong</button>
    <button class="f-btn on" data-conf="Good Edge">Good Edge</button>
    <button class="f-btn on" data-conf="Slight Edge">Slight Edge</button>
    <button class="f-btn on" data-conf="Too Close">Too Close</button>
    <button class="f-btn off" id="value-toggle" data-value="1">âš¡ Value Only</button>
  </div>
  <div id="results-area"></div>
  <button class="debug-toggle hidden" id="debug-toggle">ğŸ” DEBUG</button>
  <div class="debug-panel hidden" id="debug-panel"></div>
</div>
</div>


<script>
var LEAGUES = [
  // â”€â”€ England â”€â”€
  {id:39,  name:'Premier League',      flag:'ğŸ´â€', season:2025},
  {id:40,  name:'Championship',        flag:'ğŸ´â€', season:2025},
  {id:41,  name:'League One',          flag:'ğŸ´â€', season:2025},
  {id:42,  name:'League Two',          flag:'ğŸ´â€', season:2025},
  {id:43,  name:'National League',     flag:'ğŸ´â€', season:2025},
  // â”€â”€ Germany â”€â”€
  {id:78,  name:'Bundesliga',          flag:'ğŸ‡©ğŸ‡ª', season:2025},
  {id:79,  name:'2. Bundesliga',       flag:'ğŸ‡©ğŸ‡ª', season:2025},
  {id:80,  name:'3. Liga',             flag:'ğŸ‡©ğŸ‡ª', season:2025},
  // â”€â”€ Spain â”€â”€
  {id:140, name:'La Liga',             flag:'ğŸ‡ªğŸ‡¸', season:2025},
  {id:141, name:'La Liga 2',           flag:'ğŸ‡ªğŸ‡¸', season:2025},
  // â”€â”€ Italy â”€â”€
  {id:135, name:'Serie A',             flag:'ğŸ‡®ğŸ‡¹', season:2025},
  {id:136, name:'Serie B',             flag:'ğŸ‡®ğŸ‡¹', season:2025},
  // â”€â”€ France â”€â”€
  {id:61,  name:'Ligue 1',             flag:'ğŸ‡«ğŸ‡·', season:2025},
  {id:62,  name:'Ligue 2',             flag:'ğŸ‡«ğŸ‡·', season:2025},
  {id:63,  name:'National',            flag:'ğŸ‡«ğŸ‡·', season:2025},
  // â”€â”€ Netherlands â”€â”€
  {id:88,  name:'Eredivisie',          flag:'ğŸ‡³ğŸ‡±', season:2025},
  {id:89,  name:'Eerste Divisie',      flag:'ğŸ‡³ğŸ‡±', season:2025},
  // â”€â”€ Portugal â”€â”€
  {id:94,  name:'Primeira Liga',       flag:'ğŸ‡µğŸ‡¹', season:2025},
  {id:95,  name:'Liga Portugal 2',     flag:'ğŸ‡µğŸ‡¹', season:2025},
  // â”€â”€ Belgium â”€â”€
  {id:144, name:'Pro League',          flag:'ğŸ‡§ğŸ‡ª', season:2025},
  {id:145, name:'Eerste Nationale',    flag:'ğŸ‡§ğŸ‡ª', season:2025},
  // â”€â”€ Turkey â”€â”€
  {id:203, name:'SÃ¼per Lig',           flag:'ğŸ‡¹ğŸ‡·', season:2025},
  {id:204, name:'1. Lig',              flag:'ğŸ‡¹ğŸ‡·', season:2025},
  // â”€â”€ Norway â”€â”€
  {id:103, name:'Eliteserien',         flag:'ğŸ‡³ğŸ‡´', season:2025},
  {id:104, name:'1. divisjon',         flag:'ğŸ‡³ğŸ‡´', season:2025},
  {id:105, name:'2. divisjon',         flag:'ğŸ‡³ğŸ‡´', season:2025},
  // â”€â”€ Sweden â”€â”€
  {id:113, name:'Allsvenskan',         flag:'ğŸ‡¸ğŸ‡ª', season:2025},
  {id:114, name:'Superettan',          flag:'ğŸ‡¸ğŸ‡ª', season:2025},
  // â”€â”€ Denmark â”€â”€
  {id:119, name:'Superliga',           flag:'ğŸ‡©ğŸ‡°', season:2025},
  {id:120, name:'1. Division',         flag:'ğŸ‡©ğŸ‡°', season:2025},
  // â”€â”€ Switzerland â”€â”€
  {id:207, name:'Super League',        flag:'ğŸ‡¨ğŸ‡­', season:2025},
  {id:208, name:'Challenge League',    flag:'ğŸ‡¨ğŸ‡­', season:2025},
  // â”€â”€ Austria â”€â”€
  {id:218, name:'Bundesliga',          flag:'ğŸ‡¦ğŸ‡¹', season:2025},
  {id:219, name:'2. Liga',             flag:'ğŸ‡¦ğŸ‡¹', season:2025},
  // â”€â”€ Poland â”€â”€
  {id:106, name:'Ekstraklasa',         flag:'ğŸ‡µğŸ‡±', season:2025},
  {id:107, name:'I liga',              flag:'ğŸ‡µğŸ‡±', season:2025},
  // â”€â”€ MLS / CONCACAF â”€â”€
  {id:253, name:'MLS',                 flag:'ğŸ‡ºğŸ‡¸', season:2025},
  {id:254, name:'USL Championship',    flag:'ğŸ‡ºğŸ‡¸', season:2025},
  {id:262, name:'Liga MX',             flag:'ğŸ‡²ğŸ‡½', season:2025},
  // â”€â”€ South America â”€â”€
  {id:265, name:'Primera Division',    flag:'ğŸ‡¨ğŸ‡±', season:2025},
  {id:266, name:'Primera B',           flag:'ğŸ‡¨ğŸ‡±', season:2025},
  // â”€â”€ Europe â”€â”€
  {id:2,   name:'Champions League',    flag:'ğŸ†', season:2025},
  {id:3,   name:'Europa League',       flag:'ğŸ†', season:2025},
  {id:848, name:'Conference League',   flag:'ğŸ†', season:2025},
];

var API_KEY = '';
var ODDS_API_KEY = '';
var loadGen  = 0;

// Set of all league IDs we track â€” used to filter form data to competitive league games only
// The Odds API sport key mapping for our leagues
var ODDS_SPORT_MAP = {
  39:'soccer_epl', 40:'soccer_efl_champ', 41:'soccer_efl_league_one', 42:'soccer_efl_league_two',
  78:'soccer_germany_bundesliga', 79:'soccer_germany_bundesliga2',
  140:'soccer_spain_la_liga', 141:'soccer_spain_segunda_division',
  135:'soccer_italy_serie_a', 136:'soccer_italy_serie_b',
  61:'soccer_france_ligue_one', 62:'soccer_france_ligue_two',
  88:'soccer_netherlands_eredivisie',
  94:'soccer_portugal_primeira_liga',
  144:'soccer_belgium_first_div',
  203:'soccer_turkey_super_league',
  103:'soccer_norway_eliteserien',
  113:'soccer_sweden_allsvenskan',
  119:'soccer_denmark_superliga',
  207:'soccer_switzerland_superleague',
  218:'soccer_austria_bundesliga',
  106:'soccer_poland_ekstraklasa',
  253:'soccer_usa_mls'
};

var LEAGUE_IDS = {};
// Include all domestic leagues but exclude European/international cups
var EXCLUDE_FROM_FORM = {2:1, 3:1, 848:1, 1:1, 5:1, 667:1};
LEAGUES.forEach(function(l){ if(!EXCLUDE_FROM_FORM[l.id]) LEAGUE_IDS[String(l.id)] = true; });

/* â”€â”€ HELPERS â”€â”€ */
function el(id){ return document.getElementById(id); }
function show(id){ var e=el(id); if(e) e.classList.remove('hidden'); }
function hide(id){ var e=el(id); if(e) e.classList.add('hidden'); }
function pad(n){ return String(n).padStart(2,'0'); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function todayStr(){ var d=new Date(); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function addDays(str,n){ var p=str.split('-'); var d=new Date(+p[0],+p[1]-1,+p[2]+n); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function dateLabel(str){
  var diff=Math.round((new Date(str+'T12:00:00')-new Date(todayStr()+'T12:00:00'))/864e5);
  if(diff===0) return 'Today'; if(diff===1) return 'Tomorrow'; if(diff===-1) return 'Yesterday';
  return new Date(str+'T12:00:00').toLocaleDateString([],{weekday:'short',day:'numeric',month:'short'});
}

/* â”€â”€ XHR â”€â”€ */
function xhr(url){
  return new Promise(function(resolve){
    var x = new XMLHttpRequest();
    x.open('GET', url, true);
    x.setRequestHeader('x-apisports-key', API_KEY);
    x.setRequestHeader('x-rapidapi-key',  API_KEY);
    x.setRequestHeader('x-rapidapi-host', 'v3.football.api-sports.io');
    x.timeout = 15000;
    x.onload = function(){ try{ resolve(JSON.parse(x.responseText)); }catch(e){ resolve({errors:{},results:0,response:[]}); } };
    x.onerror = x.ontimeout = function(){ resolve({errors:{},results:0,response:[]}); };
    x.send();
  });
}

/* â”€â”€ CACHE (localStorage, keyed by date) â”€â”€ */
function cacheKey(date){ return 'mo_day_v20_' + date; }
function cacheGet(date){
  try{
    var raw = localStorage.getItem(cacheKey(date));
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function cacheSet(date, data){
  try{
    // Prune old cache entries â€” keep only last 3 days for this version
    var keep = [cacheKey(date), cacheKey(addDays(date,-1)), cacheKey(addDays(date,-2))];
    for(var i=localStorage.length-1; i>=0; i--){
      var k = localStorage.key(i);
      if(k && k.indexOf('mo_day_')===0 && keep.indexOf(k)===-1){
        localStorage.removeItem(k);
      }
    }
    localStorage.setItem(cacheKey(date), JSON.stringify(data));
  }catch(e){}
}

/* â”€â”€ KEY â”€â”€ */
function saveKey(){
  var k = el('api-key-input').value.trim();
  if(!k){ alert('Please paste your API-Football key first.'); return; }
  API_KEY = k;
  try{ localStorage.setItem('mo_key', k); }catch(e){}
  var ok = el('odds-api-key-input').value.trim();
  if(ok){ ODDS_API_KEY=ok; try{ localStorage.setItem('mo_odds_key', ok); }catch(e){} }
  hide('key-section'); show('key-bar'); show('main-app');
  show('debug-toggle');
  buildQuickDates();
  loadAll();
}
function changeKey(){
  API_KEY = '';
  try{ localStorage.removeItem('mo_key'); }catch(e){}
  hide('key-bar'); hide('main-app');
  el('api-key-input').value = '';
  show('key-section');
}

/* â”€â”€ QUICK DATE PILLS â”€â”€ */
function buildQuickDates(){
  var today = todayStr(), c = el('quick-dates');
  c.innerHTML = '';
  [-2,-1,0,1,2,3,4,5,6].forEach(function(i){
    var d = addDays(today, i);
    var btn = document.createElement('button');
    btn.className = 'qd-btn' + (d===today?' active':'');
    btn.setAttribute('data-date', d);
    btn.textContent = i===0?'Today':i===1?'Tomorrow':i===-1?'Yesterday'
      :new Date(d+'T12:00:00').toLocaleDateString([],{weekday:'short',day:'numeric'});
    btn.addEventListener('click', function(){ el('date-input').value=d; setQD(d); loadAll(); });
    c.appendChild(btn);
  });
}
function setQD(date){
  document.querySelectorAll('.qd-btn').forEach(function(b){
    b.classList.toggle('active', b.getAttribute('data-date')===date);
  });
}

/* â”€â”€ MAIN LOAD â”€â”€ */
function loadAll(){
  var date = el('date-input').value || todayStr();
  var gen  = ++loadGen;
  setQD(date);
  el('results-area').innerHTML = '';
  hide('main-error');
  hide('cached-note');
  hide('filter-bar');
  window._oddsFetching = false;  // reset so new load can fetch odds

  // â”€â”€ Check cache first â”€â”€
  var cached = cacheGet(date);
  if(cached && cached.groups && cached.formStore){
    show('cached-note');
    // Render immediately from cache (no odds yet)
    renderAll(cached.groups, date, false, cached.formStore, cached.h2hStore, cached.eventsStore, {});
    // Then fetch odds fresh in background â€” never cached so always current
    var todayFxIds=[];
    cached.groups.forEach(function(g){
      g.fixtures.forEach(function(f){
        var wrap=document.querySelector('.fx-wrap[data-fid="'+f.fixture.id+'"]');
        todayFxIds.push({
          id:     f.fixture.id,
          league: (f.league&&f.league.id)||g.lg.id,
          season: (f.league&&f.league.season)||g.lg.season,
          conf:   wrap?wrap.getAttribute('data-conf'):'',
          ht:     f.teams.home.name,
          at:     f.teams.away.name
        });
      });
    });
    show('prog-wrap');
    el('prog-fill').style.width='90%';
    el('prog-label').textContent='Refreshing odds...';
    fetchOddsLive(todayFxIds, 0, gen);
    return;
  }

  // â”€â”€ Full fetch â”€â”€
  el('load-btn').disabled = true;
  show('prog-wrap');
  el('prog-fill').style.width = '0%';

  var total     = LEAGUES.length;
  var done      = 0;
  var groups    = [];   // [{lg, fixtures}]

  // Phase 1: fetch all fixture lists sequentially
  function fetchLeagues(i){
    if(gen !== loadGen){ el('load-btn').disabled=false; hide('prog-wrap'); return; }
    if(i >= total){
      // Move to phase 2: fetch form data
      fetchFormData(gen, groups, date);
      return;
    }
    var lg = LEAGUES[i];
    xhr('https://v3.football.api-sports.io/fixtures?league='+lg.id+'&season='+lg.season+'&date='+date)
    .then(function(json){
      if(gen !== loadGen) return;
      done++;
      el('prog-fill').style.width = Math.round(done/total*50)+'%'; // first 50% = fixture lists
      el('prog-label').textContent = 'Fixtures '+done+' / '+total+'...';
      var fx = Array.isArray(json.response) ? json.response : [];
      if(fx.length > 0){
        fx.sort(function(a,b){ return new Date(a.fixture.date)-new Date(b.fixture.date); });
        groups.push({lg:lg, fixtures:fx});
      }
      fetchLeagues(i+1);
    });
  }
  fetchLeagues(0);
}

/* â”€â”€ PHASE 2: collect unique team IDs, fetch form for each, then render â”€â”€ */
function fetchFormData(gen, groups, date){
  if(gen !== loadGen) return;
  if(groups.length === 0){
    hide('prog-wrap'); el('load-btn').disabled=false;
    el('results-area').innerHTML='<div class="no-fx">No fixtures found for '+esc(dateLabel(date))+'<br><span style="color:var(--t3);font-size:9px">Try the arrows or pick another date</span></div>';
    return;
  }
  // Unique teams
  var teamMap={};
  groups.forEach(function(g){ g.fixtures.forEach(function(f){
    var s=(f.league&&f.league.season)||g.lg.season;
    teamMap[String(f.teams.home.id)]=s; teamMap[String(f.teams.away.id)]=s;
  });});
  // Unique H2H pairs
  var h2hMap={};
  groups.forEach(function(g){ g.fixtures.forEach(function(f){
    var key=f.teams.home.id+'_'+f.teams.away.id;
    h2hMap[key]={hid:f.teams.home.id, aid:f.teams.away.id};
  });});
  var teamIds=Object.keys(teamMap);
  var h2hKeys=Object.keys(h2hMap);
  var doneCalls=0;
  var formStore={};
  var h2hStore={};
  var eventsStore={};   // fixtureId -> events[]
  var oddsStore={};     // fixtureId -> {home, draw, away} decimal odds
  // totalCalls updated after phase 1 when we know fixture IDs
  var totalCalls=teamIds.length+h2hKeys.length; // +event calls added later

  function tick(label){
    doneCalls++;
    el('prog-label').textContent=label||('Loading '+doneCalls+' / '+totalCalls+'...');
    el('prog-fill').style.width=(50+Math.round(doneCalls/totalCalls*50))+'%';
  }

  // â”€â”€ Phase A: fetch team form (last 20, no events yet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fetchTeams(i){
    if(gen!==loadGen){ el('load-btn').disabled=false; hide('prog-wrap'); return; }
    if(i>=teamIds.length){ fetchH2H(0); return; }
    var tid=teamIds[i];
    xhr('https://v3.football.api-sports.io/fixtures?team='+tid+'&last=20')
    .then(function(json){
      if(gen!==loadGen) return;
      tick('Form '+doneCalls+' / '+teamIds.length+'...');
      var resp=Array.isArray(json.response)?json.response:[];
      formStore[String(tid)]=resp;
      fetchTeams(i+1);
    });
  }

  // â”€â”€ Phase B: fetch H2H â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fetchH2H(i){
    if(gen!==loadGen){ el('load-btn').disabled=false; hide('prog-wrap'); return; }
    if(i>=h2hKeys.length){ buildEventIds(); return; }
    var key=h2hKeys[i], pair=h2hMap[key];
    xhr('https://v3.football.api-sports.io/fixtures/headtohead?h2h='+pair.hid+'-'+pair.aid+'&last=20')
    .then(function(json){
      if(gen!==loadGen) return;
      tick('H2H '+doneCalls+' / '+(teamIds.length+h2hKeys.length)+'...');
      h2hStore[String(key)]=Array.isArray(json.response)?json.response:[];
      fetchH2H(i+1);
    });
  }

  // â”€â”€ Phase C: collect unique fixture IDs for venue-specific last 5 games â”€â”€â”€
  // For each fixture on the current date we need:
  //   home team: last 5 home games -> fixture IDs
  //   away team: last 5 away games -> fixture IDs
  // We deduplicate so shared fixtures are only fetched once
  function buildEventIds(){
    if(gen!==loadGen) return;
    var fxIdSet={};  // fixtureId -> true

    groups.forEach(function(g){
      g.fixtures.forEach(function(f){
        var viewDate=el('date-input').value||todayStr();
        var htFx=formStore[f.teams.home.id]||[];
        var atFx=formStore[f.teams.away.id]||[];

        // collect last 5 venue-specific completed games for each team
        function collect(fx, tid, venue){
          var count=0;
          for(var i=0;i<fx.length;i++){
            var g2=fx[i];
            if(!g2||!g2.fixture||!g2.teams||!g2.goals) continue;
            var st=g2.fixture.status&&g2.fixture.status.short;
            if(st!=='FT'&&st!=='AET'&&st!=='PEN'&&st!=='AWD') continue;
            if(viewDate&&g2.fixture.date&&g2.fixture.date.slice(0,10)===viewDate) continue;
            var isH=g2.teams.home&&g2.teams.home.id===tid;
            var isA=g2.teams.away&&g2.teams.away.id===tid;
            if(venue==='home'&&!isH) continue;
            if(venue==='away'&&!isA) continue;
            fxIdSet[g2.fixture.id]=true;
            count++;
            if(count===5) break;
          }
        }
        collect(htFx, f.teams.home.id, 'home');
        collect(atFx, f.teams.away.id, 'away');
      });
    });

    var fxIds=Object.keys(fxIdSet);
    // Update total now we know how many event calls
    totalCalls=doneCalls+fxIds.length;
    el('prog-label').textContent='Events 0 / '+fxIds.length+'...';
    fetchEvents(fxIds, 0);
  }

  // â”€â”€ Phase D: fetch events for each unique fixture ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fetchEvents(ids, i){
    if(gen!==loadGen){ el('load-btn').disabled=false; hide('prog-wrap'); return; }
    if(i>=ids.length){
      // Phase D done â€” now fetch odds for today's fixtures
      // Build richer fixture context for odds fetch: {id, league, season, conf, ht, at}
      var todayFxIds=[];
      groups.forEach(function(g){
        g.fixtures.forEach(function(f){
          var wrap=document.querySelector('.fx-wrap[data-fid="'+f.fixture.id+'"]');
          todayFxIds.push({
            id:     f.fixture.id,
            league: (f.league&&f.league.id)   || g.lg.id,
            season: (f.league&&f.league.season)|| g.lg.season,
            conf:   wrap?wrap.getAttribute('data-conf'):'',
            ht:     f.teams.home.name,
            at:     f.teams.away.name
          });
        });
      });
      fetchOdds(todayFxIds, 0);
      return;
    }
    var fid=ids[i];
    xhr('https://v3.football.api-sports.io/fixtures/events?fixture='+fid)
    .then(function(json){
      if(gen!==loadGen) return;
      tick('Events '+(i+1)+' / '+ids.length+'...');
      eventsStore[fid]=Array.isArray(json.response)?json.response:[];
      fetchEvents(ids,i+1);
    });
  }

  // â”€â”€ Phase E: fetch odds for each fixture on today's card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fetchOdds(ids, i){
    // If Odds API key available, use that instead (better prices, fewer requests)
    if(ODDS_API_KEY && i===0){
      fetchOddsLive(ids, 0, gen);
      // Still need to hide progress and cache when done â€” fetchOddsLive handles that
      // but we need to save cache here without odds
      var payload={groups:groups,formStore:formStore,h2hStore:h2hStore,eventsStore:eventsStore};
      cacheSet(date,payload);
      hide('prog-wrap'); el('load-btn').disabled=false;
      return;
    }
    if(gen!==loadGen){ el('load-btn').disabled=false; hide('prog-wrap'); return; }
    if(i>=ids.length){
      dbg('Odds complete. Found for '+Object.keys(oddsStore).length+' of '+ids.length+' fixtures.');
      hide('prog-wrap'); el('load-btn').disabled=false;
      // Cache everything except odds â€” odds are always fetched fresh to avoid stale prices
      var payload={groups:groups,formStore:formStore,h2hStore:h2hStore,eventsStore:eventsStore};
      cacheSet(date,payload);
      // If groups defined (fresh fetch), do full render; else patch odds into existing DOM
      if(groups && groups.length){
        renderAll(groups,date,false,formStore,h2hStore,eventsStore,oddsStore);
      } else {
        applyOddsToDOM(oddsStore);
      }
      return;
    }
    var fx=ids[i];
    var fid=fx.id, lgid=fx.league, season=fx.season;
    if(i===0) dbg('Fetching odds for '+ids.length+' fixtures. First: fixture='+fid+' league='+lgid+' season='+season);
    var url='https://v3.football.api-sports.io/odds?fixture='+fid+'&league='+lgid+'&season='+season;
    xhr(url).then(function(json){
      if(gen!==loadGen) return;
      if(i===0){
        dbg('errors: '+JSON.stringify(json.errors));
        dbg('results: '+json.results+' paging: '+JSON.stringify(json.paging));
        dbg('resp len: '+(Array.isArray(json.response)?json.response.length:0));
        if(Array.isArray(json.response)&&json.response.length>0){
          var f0=json.response[0];
          dbg('resp[0] fixture id: '+(f0.fixture&&f0.fixture.id));
          var bm0=f0.bookmakers||[];
          dbg('bookmakers ('+bm0.length+'): '+bm0.slice(0,4).map(function(b){return b.name+'('+b.id+')';}).join(', '));
          if(bm0.length>0){
            dbg('bets available: '+bm0[0].bets.map(function(b){return b.name;}).join(' | '));
          }
        }
      }
      var resp=Array.isArray(json.response)?json.response:[];
      var found=false;
      for(var b=0;b<resp.length&&!found;b++){
        var bookmakers=resp[b].bookmakers||[];
        for(var bk=0;bk<bookmakers.length&&!found;bk++){
          var bets=bookmakers[bk].bets||[];
          for(var bt=0;bt<bets.length&&!found;bt++){
            var betName=(bets[bt].name||'').toLowerCase();
            if(betName.indexOf('match winner')>-1||betName.indexOf('1x2')>-1||betName==='match result'){
              var vals=bets[bt].values||[];
              var o={home:null,draw:null,away:null};
              vals.forEach(function(v){
                var val=parseFloat(v.odd);
                if(v.value==='Home'||v.value==='1') o.home=val;
                else if(v.value==='Draw'||v.value==='X') o.draw=val;
                else if(v.value==='Away'||v.value==='2') o.away=val;
              });
              if(o.home&&o.draw&&o.away){
                o._bk=bookmakers[bk].name;
                oddsStore[String(fid)]=o;
                found=true;
                if(i===0) dbg('FOUND via '+bookmakers[bk].name+': H='+o.home+' D='+o.draw+' A='+o.away);
              }
            }
          }
        }
      }
      setTimeout(function(){ fetchOdds(ids, i+1); }, 200);
    });
  }

  fetchTeams(0);
}

/* â”€â”€ LIVE ODDS FETCH (top-level, used on cache-hit path) â”€â”€ */
function fetchOddsLive(ids, i, gen){
  // If no Odds API key, fall back to API-Football odds
  if(!ODDS_API_KEY){
    fetchOddsLiveFallback(ids, i, gen);
    return;
  }
  // Only fetch on first call (i===0) â€” we do it all at once by sport
  if(i>0) return;
  if(window._oddsFetching){ dbg('Odds fetch already running'); return; }
  window._oddsFetching=true;
  if(!window._liveOddsStore) window._liveOddsStore={};

  // Group fixtures by sport key, only Strong Signal + Good Edge
  var sportGroups={};
  // ids is array of {id, league, season, conf, ht, at}
  ids.forEach(function(fx){
    var conf=fx.conf;
    if(conf!=='Strong Signal'&&conf!=='Good Edge') return;
    var sport=ODDS_SPORT_MAP[fx.league];
    if(!sport) return;
    if(!sportGroups[sport]) sportGroups[sport]=[];
    sportGroups[sport].push(fx);
  });

  var sports=Object.keys(sportGroups);
  dbg('Odds API: fetching '+sports.length+' sports for Strong/Good Edge fixtures');
  if(!sports.length){ window._oddsFetching=false; hide('prog-wrap'); return; }

  var done=0;
  sports.forEach(function(sport){
    var fxList=sportGroups[sport];
    var url='https://api.the-odds-api.com/v4/sports/'+sport+'/odds/'+
      '?apiKey='+ODDS_API_KEY+
      '&regions=uk&markets=h2h&oddsFormat=decimal&bookmakers=bet365';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      dbg('Sport '+sport+': '+(Array.isArray(data)?data.length:0)+' games returned');
      if(Array.isArray(data)){
        dbg('Games from API for '+sport+':');
        data.forEach(function(game){
          dbg('  API: "'+game.home_team+'" vs "'+game.away_team+'"');
        });
        dbg('Our fixtures needing match:');
        fxList.forEach(function(fx){ dbg('  Us: "'+fx.ht+'" vs "'+fx.at+'" ('+fx.conf+')'); });
        data.forEach(function(game){
          // Match to our fixture by team name similarity
          fxList.forEach(function(fx){
            var hn=normalize(fx.ht), an=normalize(fx.at);
            var ghn=normalize(game.home_team), gan=normalize(game.away_team);
            dbg('Comparing: norm["'+fx.ht+'"]="'+hn+'" vs norm["'+game.home_team+'"]="'+ghn+'"');
            if(nameSimilar(hn,ghn)&&nameSimilar(an,gan)){
              // Extract bet365 odds
              var bk=(game.bookmakers||[]).find(function(b){ return b.key==='bet365'; });
              if(!bk) bk=(game.bookmakers||[])[0];
              if(!bk) return;
              var mkt=(bk.markets||[]).find(function(m){ return m.key==='h2h'; });
              if(!mkt) return;
              var o={home:null,draw:null,away:null,_bk:bk.title};
              (mkt.outcomes||[]).forEach(function(oc){
                var n=normalize(oc.name);
                if(nameSimilar(n,hn)) o.home=oc.price;
                else if(n==='draw') o.draw=oc.price;
                else o.away=oc.price;
              });
              if(o.home&&o.draw&&o.away){
                window._liveOddsStore[String(fx.id)]=o;
                dbg('Matched: '+fx.ht+' vs '+fx.at+' H='+o.home+' D='+o.draw+' A='+o.away);
              }
            }
          });
        });
      }
      done++;
      if(done===sports.length){
        window._oddsFetching=false;
        hide('prog-wrap');
        dbg('Odds API done. Found for '+Object.keys(window._liveOddsStore).length+' fixtures');
        applyOddsToDOM(window._liveOddsStore||{});
        window._liveOddsStore={};
      }
    }).catch(function(e){
      dbg('Odds API error: '+e.message);
      done++;
      if(done===sports.length){ window._oddsFetching=false; hide('prog-wrap'); }
    });
  });
}

// Fallback: use API-Football odds (one request per fixture)
function fetchOddsLiveFallback(ids, i, gen){
  if(window._oddsFetching && i===0){ dbg('Odds fetch already running, skipping duplicate'); return; }
  if(i===0) window._oddsFetching=true;
  if(gen!==loadGen){ window._oddsFetching=false; hide('prog-wrap'); return; }
  if(i>=ids.length){
    window._oddsFetching=false;
    hide('prog-wrap');
    dbg('API-Football odds done. Found for '+Object.keys(window._liveOddsStore||{}).length+' of '+ids.length);
    applyOddsToDOM(window._liveOddsStore||{});
    window._liveOddsStore={};
    return;
  }
  if(!window._liveOddsStore) window._liveOddsStore={};
  var fx=ids[i], fid=fx.id, lgid=fx.league, season=fx.season;
  var url='https://v3.football.api-sports.io/odds?fixture='+fid+'&league='+lgid+'&season='+season;
  xhr(url).then(function(json){
    if(gen!==loadGen){ window._oddsFetching=false; return; }
    var resp=Array.isArray(json.response)?json.response:[];
    var found=false;
    for(var b=0;b<resp.length&&!found;b++){
      var bookmakers=resp[b].bookmakers||[];
      for(var bk=0;bk<bookmakers.length&&!found;bk++){
        var bets=bookmakers[bk].bets||[];
        for(var bt=0;bt<bets.length&&!found;bt++){
          var betName=(bets[bt].name||'').toLowerCase();
          if(betName.indexOf('match winner')>-1||betName.indexOf('1x2')>-1||betName==='match result'){
            var vals=bets[bt].values||[];
            var o={home:null,draw:null,away:null};
            vals.forEach(function(v){
              var val=parseFloat(v.odd);
              if(v.value==='Home'||v.value==='1') o.home=val;
              else if(v.value==='Draw'||v.value==='X') o.draw=val;
              else if(v.value==='Away'||v.value==='2') o.away=val;
            });
            if(o.home&&o.draw&&o.away){
              o._bk=bookmakers[bk].name;
              window._liveOddsStore[String(fid)]=o;
              found=true;
            }
          }
        }
      }
    }
    setTimeout(function(){ fetchOddsLiveFallback(ids, i+1, gen); }, 200);
  });
}

// Team name normalisation for matching
function normalize(s){
  return (s||'').toLowerCase()
    .replace(/fc|afc|cf|sc|ac|cd|sd|ud|rcd|rc|athletic|atletico|atlÃ©tico/g,'')
    .replace(/[^a-z0-9]/g,' ').replace(/\s+/g,' ').trim();
}
function nameSimilar(a,b){
  if(!a||!b) return false;
  if(a===b) return true;
  // Check if one contains the other (handles truncated names)
  if(a.length>3&&b.indexOf(a)>-1) return true;
  if(b.length>3&&a.indexOf(b)>-1) return true;
  return false;
}

/* â”€â”€ PATCH ODDS INTO EXISTING DOM (used on cache-hit path) â”€â”€ */
function applyOddsToDOM(oddsStore){
  hide('prog-wrap');
  // Re-render just the odds/value parts of each visible fixture
  // We store fid on fx-wrap as data-fid during buildFixtureEl
  document.querySelectorAll('.fx-wrap[data-fid]').forEach(function(wrap){
    var fid = wrap.getAttribute('data-fid');
    var odds = oddsStore && oddsStore[String(fid)];
    if(!odds) return;
    // Remove existing odds row if any
    var existing = wrap.querySelector('.fp-odds-row');
    if(existing) existing.remove();
    // Get stored probabilities from data attributes
    var ph = parseFloat(wrap.getAttribute('data-ph')||0);
    var pd = parseFloat(wrap.getAttribute('data-pd')||0);
    var pa = parseFloat(wrap.getAttribute('data-pa')||0);
    if(!ph) return;
    var iH=1/odds.home*100, iD=1/odds.draw*100, iA=1/odds.away*100;
    var eH=ph-iH, eD=pd-iD, eA=pa-iA;
    var MIN_EDGE=4;
    // Update or add value badge on strip
    var strip = wrap.querySelector('.fp-strip');
    if(strip){
      var oldVal = strip.querySelector('.fp-value');
      if(oldVal) oldVal.previousSibling && oldVal.previousSibling.remove(), oldVal.remove();
      var edges=[
        {label:'H',edge:eH},{label:'D',edge:eD},{label:'A',edge:eA}
      ].filter(function(e){return e.edge>=MIN_EDGE;}).sort(function(a,b){return b.edge-a.edge;});
      if(edges.length>0){
        var best=edges[0];
        var ec=best.edge>=12?'#39ff88':best.edge>=7?'#ffe600':'#ff9a1f';
        var dot=document.createElement('span'); dot.className='fp-div'; dot.textContent='Â·';
        var badge=document.createElement('span'); badge.className='fp-value';
        badge.style.color=ec; badge.textContent='VALUE: '+best.label+' +'+best.edge.toFixed(1)+'%';
        strip.appendChild(dot); strip.appendChild(badge);
        wrap.setAttribute('data-value','1');
      }
    }
    // Add odds row
    function mkOddsCell(label,o,edge){
      var span=document.createElement('span'); span.className='fp-odds-item';
      var lbl=document.createElement('span'); lbl.className='fp-odds-label'; lbl.textContent=label;
      var prc=document.createElement('span'); prc.className='fp-odds-price'; prc.textContent=o.toFixed(2);
      span.appendChild(lbl); span.appendChild(prc);
      if(edge>=MIN_EDGE){
        var es=document.createElement('span'); es.className='fp-odds-edge';
        es.style.color=edge>=12?'#39ff88':edge>=7?'#ffe600':'#ff9a1f';
        es.textContent=' +'+edge.toFixed(1)+'%'; span.appendChild(es);
      } else if(edge<=-4){
        var es=document.createElement('span'); es.className='fp-odds-edge';
        es.style.color='#ff4040'; es.textContent=' '+edge.toFixed(1)+'%'; span.appendChild(es);
      }
      return span;
    }
    var row=document.createElement('div'); row.className='fp-odds-row';
    var src=document.createElement('span'); src.className='fp-odds-label';
    src.style.marginRight='2px'; src.textContent=(odds._bk||'ODDS').toUpperCase().slice(0,8);
    row.appendChild(src);
    row.appendChild(mkOddsCell('H',odds.home,eH));
    row.appendChild(mkOddsCell('D',odds.draw,eD));
    row.appendChild(mkOddsCell('A',odds.away,eA));
    // Insert after strip, before table
    var tbl=wrap.querySelector('.fp-tbl');
    if(tbl) wrap.querySelector('.fp-strip').parentNode.insertBefore(row, tbl);
    else wrap.querySelector('.fp-strip').parentNode.appendChild(row);
  });
  applyFilter();
}

/* â”€â”€ RENDER ALL â”€â”€ */
function renderAll(groups, date, fromCache, formStore, h2hStore, eventsStore, oddsStore){
  var area = el('results-area');
  area.innerHTML = '';

  var totalFx = 0;
  groups.forEach(function(g){ totalFx += g.fixtures.length; });

  // Stores always passed in directly â€” no secondary cache read needed
  var fs = formStore   || {};
  var hs = h2hStore    || {};
  var es = eventsStore || {};
  var os = oddsStore   || {};

  // Show filter bar
  if(totalFx>0) show('filter-bar'); else hide('filter-bar');

  // Summary line
  var sum = document.createElement('div');
  sum.className = 'day-summary';
  sum.innerHTML = '<b>'+totalFx+'</b> fixtures Â· <b>'+groups.length+'</b> league'+(groups.length!==1?'s':'')+' Â· '+esc(dateLabel(date));
  area.appendChild(sum);

  groups.forEach(function(g, gi){
    var groupEl = document.createElement('div');
    groupEl.className = 'league-group fadein';
    groupEl.style.animationDelay = (gi*0.03)+'s';

    // â”€â”€ Header (tap to expand) â”€â”€
    var hdr = document.createElement('div');
    hdr.className = 'lg-hdr';
    hdr.innerHTML =
      '<span class="lg-flag">'+g.lg.flag+'</span>'+
      '<span class="lg-name">'+esc(g.lg.name)+'</span>'+
      '<span class="lg-count">'+g.fixtures.length+' game'+(g.fixtures.length!==1?'s':'')+'</span>'+
      '<span class="lg-chevron">&#9660;</span>';

    // â”€â”€ Body (hidden until expanded) â”€â”€
    var body = document.createElement('div');
    body.className = 'lg-body';

    // Build fixture rows (DOM ready, just hidden)
    g.fixtures.forEach(function(f, fi){
      var fxEl = buildFixtureEl(f, g.lg, fs, hs, es, os, fi === g.fixtures.length-1);
      body.appendChild(fxEl);
    });

    // Toggle on header click
    hdr.addEventListener('click', function(){
      var isOpen = body.classList.contains('open');
      if(isOpen){
        body.classList.remove('open');
        hdr.classList.remove('open');
      } else {
        body.classList.add('open');
        hdr.classList.add('open');
      }
    });

    groupEl.appendChild(hdr);
    groupEl.appendChild(body);
    area.appendChild(groupEl);
  });
}

/* â”€â”€ BUILD FIXTURE ELEMENT (with inline prediction + stats) â”€â”€ */
function buildFixtureEl(f, lg, formStore, h2hStore, eventsStore, oddsStore, isLast){
  var sb  = badge(f);
  var gH  = f.goals && f.goals.home !== null ? f.goals.home : null;
  var gA  = f.goals && f.goals.away !== null ? f.goals.away : null;
  var sc  = (gH !== null && gA !== null) ? gH+' - '+gA : 'vs';
  var ht  = f.teams.home, at = f.teams.away;
  var season = (f.league && f.league.season) || lg.season;

  var div = document.createElement('div');
  div.className = 'fx-wrap';
  div.setAttribute('data-conf','');  // filled after prediction calculated
  div.setAttribute('data-fid', String(f.fixture.id));

  // Fixture row
  var row = document.createElement('div');
  row.className = 'fx-row';

  row.innerHTML =
    '<div class="fx-teams">'+
      '<div class="fx-team">'+
        (ht.logo ? '<img src="'+esc(ht.logo)+'" alt="" loading="lazy" onerror="this.style.display=\'none\'">' : '')+
        '<span class="fx-name">'+esc(ht.name)+'</span>'+
      '</div>'+
      '<div class="fx-score">'+esc(sc)+'</div>'+
      '<div class="fx-team r">'+
        '<span class="fx-name">'+esc(at.name)+'</span>'+
        (at.logo ? '<img src="'+esc(at.logo)+'" alt="" loading="lazy" onerror="this.style.display=\'none\'">' : '')+
      '</div>'+
    '</div>'+
    '<div><span class="fx-status" style="color:'+sb.c+';background:'+sb.c+'18">'+esc(sb.t)+'</span></div>';

  div.appendChild(row);

  // Prediction + stats panel
  var hR  = formStore && formStore[String(ht.id)] ? formStore[String(ht.id)] : [];
  var aR  = formStore && formStore[String(at.id)] ? formStore[String(at.id)] : [];
  var h2h = h2hStore  && h2hStore[ht.id+'_'+at.id] ? h2hStore[ht.id+'_'+at.id] : [];

  // Fallback chain: venue-specific â†’ all games â†’ neutral baseline
  // viewDate ensures same-day completed games are excluded so predictions stay pre-match
  var viewDate = el('date-input').value || todayStr();
  // Try venue-specific first (min 4 games), fall back to all games, then neutral
  var lgId = (f.league && f.league.id) || lg.id;

  // Fallback chain:
  // 1. League venue games (home for home team, away for away team)
  // 2. League all-venue games
  // 3. Last 5 any-competition venue games (better than neutral)
  // 4. Last 5 any-competition all games
  // 5. Neutral baseline (truly last resort)
  var hmLeague = calcForm(hR, ht.id, 'home', viewDate, eventsStore, lgId);
  var hm = hmLeague
        || calcForm(hR, ht.id, 'all',  viewDate, eventsStore, lgId)
        || calcForm(hR, ht.id, 'home', viewDate, eventsStore, null, 5)
        || calcForm(hR, ht.id, 'all',  viewDate, eventsStore, null, 5)
        || neutralForm();

  var amLeague = calcForm(aR, at.id, 'away', viewDate, eventsStore, lgId);
  var am = amLeague
        || calcForm(aR, at.id, 'all',  viewDate, eventsStore, lgId)
        || calcForm(aR, at.id, 'away', viewDate, eventsStore, null, 5)
        || calcForm(aR, at.id, 'all',  viewDate, eventsStore, null, 5)
        || neutralForm();

  {
    var h2hStat = calcH2H(h2h, ht.id, at.id, viewDate, lgId);
    var L   = lambdas(hm, am, h2hStat);
    var P   = probs(L.h, L.a);
    var mx  = Math.max(P.h, P.d, P.a);
    var pred = mx===P.h ? 'Home Win' : mx===P.d ? 'Draw' : 'Away Win';
    var cf  = conf(mx);
    div.setAttribute('data-conf', cf.l);
    div.setAttribute('data-value', '0');
    div.setAttribute('data-ph', P.h.toFixed(3));
    div.setAttribute('data-pd', P.d.toFixed(3));
    div.setAttribute('data-pa', P.a.toFixed(3));

    // â”€â”€ Odds & value calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var fid = f.fixture.id;
    var odds = (oddsStore && oddsStore[String(fid)]) ? oddsStore[String(fid)] : null;
    var valueHtml = '';
    var oddsRowHtml = '';

    if(odds){
      // Implied probabilities (decimal odds -> implied prob, no vig removal for simplicity)
      var iH = 1/odds.home*100;
      var iD = 1/odds.draw*100;
      var iA = 1/odds.away*100;

      // Edge = our model prob minus implied prob
      var eH = P.h - iH;
      var eD = P.d - iD;
      var eA = P.a - iA;

      // Find best value edge (must be 4%+ to show)
      var MIN_EDGE = 4;
      var edges = [
        {label:'H', outcome:'Home Win', edge:eH, odds:odds.home, prob:P.h, imp:iH},
        {label:'D', outcome:'Draw',     edge:eD, odds:odds.draw, prob:P.d, imp:iD},
        {label:'A', outcome:'Away Win', edge:eA, odds:odds.away, prob:P.a, imp:iA}
      ].filter(function(e){ return e.edge >= MIN_EDGE; })
       .sort(function(a,b){ return b.edge - a.edge; });

      if(edges.length > 0){
        var best = edges[0];
        var edgeColor = best.edge >= 12 ? '#39ff88' : best.edge >= 7 ? '#ffe600' : '#ff9a1f';
        valueHtml =
          '<span class="fp-div">Â·</span>'+
          '<span class="fp-value" style="color:'+edgeColor+'">'+
            'VALUE: '+best.label+' +'+best.edge.toFixed(1)+'%'+
          '</span>';
        div.setAttribute('data-value', '1');
      }

      // Odds row â€” show all three prices with edge indicator
      function oddsCell(label, o, edge){
        var eStr = edge>=MIN_EDGE
          ? '<span class="fp-odds-edge" style="color:'+(edge>=12?'#39ff88':edge>=7?'#ffe600':'#ff9a1f')+'"> +'+edge.toFixed(1)+'%</span>'
          : (edge<=-4 ? '<span class="fp-odds-edge" style="color:#ff4040"> '+edge.toFixed(1)+'%</span>' : '');
        return '<span class="fp-odds-item">'+
          '<span class="fp-odds-label">'+label+'</span>'+
          '<span class="fp-odds-price">'+o.toFixed(2)+'</span>'+
          eStr+
        '</span>';
      }
      oddsRowHtml =
        '<div class="fp-odds-row">'+
          '<span class="fp-odds-label" style="margin-right:2px">BET365</span>'+
          oddsCell('H', odds.home, eH)+
          oddsCell('D', odds.draw, eD)+
          oddsCell('A', odds.away, eA)+
        '</div>';
    }

    var panel = document.createElement('div');
    panel.innerHTML =
      // Prediction strip
      '<div class="fp-strip">'+
        '<span class="fp-pred" style="color:'+cf.c+'">'+esc(pred)+'</span>'+
        '<span class="fp-div">Â·</span>'+
        '<span class="fp-h">H '+P.h.toFixed(1)+'%</span>'+
        '<span class="fp-div">Â·</span>'+
        '<span class="fp-d">D '+P.d.toFixed(1)+'%</span>'+
        '<span class="fp-div">Â·</span>'+
        '<span class="fp-a">A '+P.a.toFixed(1)+'%</span>'+
        '<span class="fp-div">Â·</span>'+
        '<span class="fp-verdict" style="color:'+cf.c+'">'+esc(cf.l)+'</span>'+
        (h2hStat ? '<span class="fp-div">Â·</span><span class="fp-h2h">H2H: '+h2hStat.hw+'W '+h2hStat.d+'D '+h2hStat.aw+'L</span>' : '')+
        (hm.n===0||am.n===0 ? '<span class="fp-div">Â·</span><span style="color:var(--t3);font-family:var(--mono);font-size:8px">est</span>' : '')+
        valueHtml+
      '</div>'+
      oddsRowHtml+
      // Stats table
      '<table class="fp-tbl">'+
        '<tr>'+
          '<th>Team</th>'+
          '<th>xG</th>'+
          '<th>Scored</th>'+
          '<th>Conc\'d</th>'+
          '<th>Pts/G</th>'+
          '<th>CS%</th>'+
          '<th>L15</th>'+
          '<th>N</th>'+
        '</tr>'+
        statsRow(ht, hm, L.h)+
        statsRow(at, am, L.a)+
      '</table>';
    div.appendChild(panel);
  }

  return div;
}

function statsRow(team, m, xg){
  var nColor = m.n===0 ? '#ff4040' : m.n<4 ? '#ff9a1f' : '#555';
  var nLabel = m.n===0 ? 'est' : String(m.n);
  return '<tr>'+
    '<td><div class="td-team">'+
      (team.logo ? '<img src="'+esc(team.logo)+'" alt="" onerror="this.style.display=\'none\'">' : '')+
      '<span>'+esc(team.name)+'</span>'+
    '</div></td>'+
    statCell(xg.toFixed(2), '#ffe600')+
    statCell(m.avgGF.toFixed(2), '#4db8ff')+
    statCell(m.avgGA.toFixed(2), '#ff9a1f')+
    statCell(m.ppg.toFixed(2), '#39ff88')+
    statCell(Math.round(m.csRate*100)+'%', '#aaa')+
    statCell(m.lateGF!==null ? m.lateGF.toFixed(2) : '-', '#c084fc')+
    statCell(nLabel, nColor)+
  '</tr>';
}
function statCell(val, color){
  return '<td><span class="td-val" style="color:'+color+'">'+esc(String(val))+'</span></td>';
}

/* â”€â”€ MATHS â”€â”€ */
// Neutral baseline used when no form data available at all
// Assumes league-average scoring both ways â€” gives a fair 50/50 starting point
function neutralForm(){
  return {avgGF:1.35, avgGA:1.35, ppg:1.3, csRate:0.25, lateGF:null, lateGA:null, n:0, venue:'neutral'};
}

function poisPMF(l,k){
  if(l<=0) return k===0?1:0;
  var r=-l+k*Math.log(l);
  for(var i=1;i<=k;i++) r-=Math.log(i);
  return Math.exp(r);
}

function probs(hL,aL){
  var h=0,d=0,a=0;
  for(var i=0;i<=9;i++) for(var j=0;j<=9;j++){
    var p=poisPMF(hL,i)*poisPMF(aL,j);
    if(i>j) h+=p; else if(i===j) d+=p; else a+=p;
  }
  var t=h+d+a||1; return {h:h/t*100,d:d/t*100,a:a/t*100,hL:hL,aL:aL};
}

/*
  calcForm â€” recency-weighted form from up to 20 games.
  Weights decay exponentially: most recent game = weight 1.0,
  each prior game multiplied by 0.85.
  Returns weighted averages for goals, conceded, pts, clean sheets.
*/

function calcForm(fx, tid, venue, viewDate, eventsStore, leagueId, maxGames){
  if(!fx||!fx.length) return null;
  var rel=[];
  for(var i=0;i<fx.length;i++){
    var f=fx[i];
    if(!f||!f.fixture||!f.teams||!f.goals) continue;
    var st=f.fixture.status&&f.fixture.status.short;
    if(st!=='FT'&&st!=='AET'&&st!=='PEN') continue;
    // Exclude games played on the same date we are viewing â€” keeps predictions pre-match
    if(viewDate && f.fixture.date && f.fixture.date.slice(0,10)===viewDate) continue;
    // League games only â€” must be a competition we track
    if(leagueId!==null && f.league && f.league.id && !LEAGUE_IDS[String(f.league.id)]) continue;
    var isH=f.teams.home&&f.teams.home.id===tid;
    var isA=f.teams.away&&f.teams.away.id===tid;
    if(venue==='home'&&!isH) continue;
    if(venue==='away'&&!isA) continue;
    if(venue==='all'&&!isH&&!isA) continue;
    rel.push(f);
    if(rel.length===(maxGames||10)) break;
  }
  if(!rel.length) return null;
  // rel[0] = most recent (API returns newest first)
  var DECAY=0.85;
  var wGF=0, wGA=0, wPts=0, wCS=0, wTot=0;
  rel.forEach(function(f, idx){
    var w = Math.pow(DECAY, idx); // 1.0, 0.85, 0.72, 0.61 ...
    var ih = f.teams.home.id===tid;
    var sc = ih?(f.goals.home||0):(f.goals.away||0);
    var cc = ih?(f.goals.away||0):(f.goals.home||0);
    var win= ih?f.teams.home.winner:f.teams.away.winner;
    var los= ih?f.teams.away.winner:f.teams.home.winner;
    var pts= win?3:(!los?1:0);
    wGF  += w*sc;
    wGA  += w*cc;
    wPts += w*pts;
    wCS  += w*(cc===0?1:0);
    wTot += w;
  });
  // Late goals 75-90 min: look up real events from eventsStore
  var lateGF=0, lateGA=0, lateW=0;
  rel.forEach(function(f, idx){
    var w=Math.pow(DECAY,idx);
    var ih=f.teams.home.id===tid;
    var fid=f.fixture&&f.fixture.id;
    // Use eventsStore if available for this fixture
    var evts=(eventsStore&&fid&&eventsStore[fid]) ? eventsStore[fid] : [];
    var lgf=0, lga=0;
    evts.forEach(function(e){
      if(e.type!=='Goal') return;
      if(e.detail==='Own Goal') return;
      var min=e.time&&e.time.elapsed ? e.time.elapsed : 0;
      if(min>=75){
        var scorerTeamId=e.team&&e.team.id;
        if(scorerTeamId===tid) lgf++;
        else lga++;
      }
    });
    // Only count this game towards late stats if we actually had events for it
    if(evts.length>0){ lateGF+=w*lgf; lateGA+=w*lga; lateW+=w; }
  });
  return {
    avgGF:    wGF/wTot,
    avgGA:    wGA/wTot,
    ppg:      wPts/wTot,
    csRate:   wCS/wTot,
    lateGF:   lateW>0 ? lateGF/lateW : null,
    lateGA:   lateW>0 ? lateGA/lateW : null,
    n:        rel.length,
    venue:    venue
  };
}

/*
  calcH2H â€” analyse last 10 H2H fixtures at this venue.
  Returns home wins, draws, away wins, and a scoring rate adjustment.
  Only counts games where home team was home and away was away (venue-specific).
*/
function calcH2H(fx, hid, aid, viewDate, leagueId){
  if(!fx||!fx.length) return null;
  var rel=[];
  for(var i=0;i<fx.length;i++){
    var f=fx[i];
    if(!f||!f.fixture||!f.teams||!f.goals) continue;
    var st=f.fixture.status&&f.fixture.status.short;
    if(st!=='FT'&&st!=='AET'&&st!=='PEN') continue;
    if(viewDate && f.fixture.date && f.fixture.date.slice(0,10)===viewDate) continue;
    // League games only for H2H
    if(f.league && f.league.id && !LEAGUE_IDS[String(f.league.id)]) continue;
    // Only count fixtures at this venue (home team matches)
    if(f.teams.home.id===hid && f.teams.away.id===aid) rel.push(f);
    if(rel.length===10) break;
  }
  if(rel.length < 1) return null; // need at least 1 H2H game at this venue
  var DECAY=0.85;
  var hw=0, d=0, aw=0, wHG=0, wAG=0, wTot=0;
  rel.forEach(function(f, idx){
    var w=Math.pow(DECAY, idx);
    var hg=f.goals.home||0, ag=f.goals.away||0;
    wHG+=w*hg; wAG+=w*ag; wTot+=w;
    if(hg>ag) hw++; else if(hg===ag) d++; else aw++;
  });
  return {
    hw: hw, d: d, aw: aw, n: rel.length,
    hgRate: wHG/wTot,  // weighted avg home goals in H2H
    agRate: wAG/wTot   // weighted avg away goals in H2H
  };
}

/*
  lambdas â€” build Poisson attack rates blending:
  - 70% venue form
  - 30% H2H at venue (if available, else 100% form)
  Home advantage: Ã—1.08 (conservative â€” research shows ~1.1 pre-VAR, slightly less now)
*/
function lambdas(hm, am, h2h){
  var avg=1.35; // baseline league average
  // Form-based lambdas
  var fH = Math.max(0.3, (hm.avgGF/avg) * (am.avgGA/avg) * avg * 1.08);
  var fA = Math.max(0.3, (am.avgGF/avg) * (hm.avgGA/avg) * avg);
  if(!h2h){
    return {h:fH, a:fA};
  }
  // H2H-based lambdas (raw scoring rates at this venue)
  var hH = Math.max(0.3, h2h.hgRate);
  var hA = Math.max(0.3, h2h.agRate);
  // Blend: 70% form, 30% H2H
  return {
    h: 0.7*fH + 0.3*hH,
    a: 0.7*fA + 0.3*hA
  };
}

function conf(p){
  if(p>=70) return {l:'Strong Signal',c:'#39ff88'};
  if(p>=55) return {l:'Good Edge',c:'#ffe600'};
  if(p>=42) return {l:'Slight Edge',c:'#ff9a1f'};
  return {l:'Too Close',c:'#ff4040'};
}
function badge(f){
  var s=f.fixture.status.short, e=f.fixture.status.elapsed;
  if(['1H','2H','HT','ET','P'].indexOf(s)>-1) return {t:e?e+"' LIVE":'LIVE',c:'#39ff88'};
  if(s==='FT') return {t:'Full Time',c:'#555'};
  if(s==='NS') return {t:new Date(f.fixture.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),c:'#4db8ff'};
  return {t:s,c:'#ff9a1f'};
}

/* â”€â”€ EVENT LISTENERS â”€â”€ */
el('date-input').value = todayStr();
el('save-key-btn').addEventListener('click', saveKey);
el('change-key-btn').addEventListener('click', changeKey);
el('api-key-input').addEventListener('keydown', function(e){ if(e.key==='Enter') saveKey(); });
el('prev-day').addEventListener('click', function(){ var d=addDays(el('date-input').value||todayStr(),-1); el('date-input').value=d; setQD(d); loadAll(); });
el('next-day').addEventListener('click', function(){ var d=addDays(el('date-input').value||todayStr(),1); el('date-input').value=d; setQD(d); loadAll(); });
el('load-btn').addEventListener('click', function(){ setQD(el('date-input').value||todayStr()); loadAll(); });
el('date-input').addEventListener('change', function(){ setQD(el('date-input').value); loadAll(); });

/* â”€â”€ FILTER â”€â”€ */
var activeFilters = {all:true,'Strong Signal':true,'Good Edge':true,'Slight Edge':true,'Too Close':true};
var valueOnly = false;

document.querySelectorAll('.f-btn[data-conf]').forEach(function(btn){
  btn.addEventListener('click', function(){
    var conf = btn.getAttribute('data-conf');
    if(conf==='all'){
      // Toggle all on/off
      var anyOff = Object.keys(activeFilters).some(function(k){ return k!=='all' && !activeFilters[k]; });
      var newState = anyOff;
      Object.keys(activeFilters).forEach(function(k){ activeFilters[k]=newState; });
      document.querySelectorAll('.f-btn').forEach(function(b){ b.classList.toggle('on',newState); b.classList.toggle('off',!newState); });
    } else {
      activeFilters[conf] = !activeFilters[conf];
      btn.classList.toggle('on', activeFilters[conf]);
      btn.classList.toggle('off', !activeFilters[conf]);
      // Update "all" btn state
      var allOn = Object.keys(activeFilters).filter(function(k){return k!=='all';}).every(function(k){return activeFilters[k];});
      var allBtn = document.querySelector('.f-btn[data-conf="all"]');
      if(allBtn){ allBtn.classList.toggle('on',allOn); allBtn.classList.toggle('off',!allOn); }
    }
    applyFilter();
  });
});

// Value toggle
var valueToggleBtn = document.getElementById('value-toggle');
if(valueToggleBtn){
  valueToggleBtn.addEventListener('click', function(){
    valueOnly = !valueOnly;
    valueToggleBtn.classList.toggle('on', valueOnly);
    valueToggleBtn.classList.toggle('off', !valueOnly);
    applyFilter();
  });
}

function applyFilter(){
  document.querySelectorAll('.fx-wrap').forEach(function(wrap){
    var c = wrap.getAttribute('data-conf');
    var v = wrap.getAttribute('data-value');
    if(!c){ wrap.style.display=''; return; }
    var confOk = activeFilters[c] !== false;
    var valueOk = !valueOnly || v==='1';
    wrap.style.display = (confOk && valueOk) ? '' : 'none';
  });
  // Hide league groups that have no visible fixtures
  document.querySelectorAll('.league-group').forEach(function(g){
    var body = g.querySelector('.lg-body');
    if(!body) return;
    var visible = Array.from(body.querySelectorAll('.fx-wrap')).some(function(w){ return w.style.display!=='none'; });
    g.style.display = visible ? '' : 'none';
  });
}

/* â”€â”€ DEBUG â”€â”€ */
function dbg(msg){
  var panel = el('debug-panel');
  if(!panel) return;
  panel.textContent += msg + '\n';
  panel.scrollTop = panel.scrollHeight;
}
var dbgBtn = el('debug-toggle');
if(dbgBtn){
  dbgBtn.addEventListener('click', function(){
    var panel = el('debug-panel');
    if(panel) panel.classList.toggle('hidden');
    dbgBtn.textContent = (panel&&panel.classList.contains('hidden')) ? 'ğŸ” DEBUG' : 'âœ• DEBUG';
  });
}

/* â”€â”€ BOOT â”€â”€ */
try{
  var s = localStorage.getItem('mo_key');
  var ok = localStorage.getItem('mo_odds_key');
  if(ok) ODDS_API_KEY=ok;
  if(s){ API_KEY=s; hide('key-section'); show('key-bar'); show('main-app'); show('debug-toggle'); buildQuickDates(); loadAll(); }
}catch(e){}
if(!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) hide('install-hint');
</script>
</body>
</html>
