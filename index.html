<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Match Oracle"/>
<meta name="theme-color" content="#000"/>
<title>Match Oracle</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#000;
  --s1:#0c0c0c;
  --s2:#141414;
  --b1:rgba(255,255,255,.08);
  --b2:rgba(255,255,255,.16);
  --W:#ffffff;
  --Y:#ffe600;
  --Y2:#ffd000;
  --B:#4db8ff;
  --B2:#1a9fff;
  --G:#39ff88;
  --O:#ff9a1f;
  --R:#ff4040;
  --t1:#ffffff;
  --t2:#aaaaaa;
  --t3:#555555;
  --mono:'Share Tech Mono',monospace;
}
html{-webkit-text-size-adjust:100%}
body{
  background:var(--bg);color:var(--t1);
  font-family:'Barlow Condensed',system-ui,sans-serif;
  min-height:100vh;overflow-x:hidden;
  padding:env(safe-area-inset-top,0) 0 env(safe-area-inset-bottom,20px);
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:999;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.05) 3px,rgba(0,0,0,.05) 4px);
}
.topline{
  position:fixed;top:0;left:0;right:0;height:2px;z-index:1000;
  background:linear-gradient(90deg,transparent,var(--Y),transparent);
  box-shadow:0 0 22px 3px rgba(255,230,0,.45);
}
.wrap{max-width:640px;margin:0 auto;padding:22px 14px 80px;position:relative;z-index:2}

/* â”€â”€ HEADER â”€â”€ */
header{text-align:center;margin-bottom:26px;padding-top:10px}
.hline{height:1px;background:linear-gradient(90deg,transparent,rgba(255,230,0,.4),transparent);margin-bottom:18px}
.logo-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:4px}
.logo-icon{
  width:42px;height:42px;background:var(--Y);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:22px;
  clip-path:polygon(6px 0,calc(100% - 6px) 0,100% 6px,100% calc(100% - 6px),calc(100% - 6px) 100%,6px 100%,0 calc(100% - 6px),0 6px);
  box-shadow:0 0 34px rgba(255,230,0,.5);
}
.site-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(44px,10vw,68px);letter-spacing:6px;line-height:1;
  color:var(--W);text-shadow:0 0 40px rgba(255,255,255,.12);
}
.tagline{
  font-family:var(--mono);font-size:9px;letter-spacing:4px;
  color:var(--t3);text-transform:uppercase;
  margin-top:8px;padding-top:8px;border-top:1px solid var(--b1);
}
.tagline .sep{color:var(--Y);margin:0 4px}

/* â”€â”€ CARD â”€â”€ */
.card{
  background:var(--s1);border:1px solid var(--b1);
  border-radius:3px;padding:18px;margin-bottom:10px;
  position:relative;overflow:hidden;
}
.card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(77,184,255,.3),transparent);
}
.slabel{
  font-family:var(--mono);font-size:9px;letter-spacing:3px;
  color:var(--t3);text-transform:uppercase;
  display:flex;align-items:center;gap:8px;margin-bottom:14px;
}
.slabel::after{content:'';flex:1;height:1px;background:var(--b1)}

/* â”€â”€ INPUTS â”€â”€ */
input[type=password],input[type=date]{
  width:100%;background:rgba(0,0,0,.7);border:1px solid var(--b2);
  color:var(--W);padding:13px 16px;font-size:16px;
  font-family:'Barlow Condensed',sans-serif;font-weight:600;letter-spacing:.5px;
  outline:none;border-radius:3px;-webkit-appearance:none;appearance:none;
  transition:border-color .2s,box-shadow .2s;
}
input:focus{border-color:var(--Y);box-shadow:0 0 0 2px rgba(255,230,0,.1)}
input[type=date]{color-scheme:dark}
input::placeholder{color:var(--t3)}

/* â”€â”€ BUTTONS â”€â”€ */
button{font-family:'Barlow Condensed',sans-serif;cursor:pointer;-webkit-appearance:none;appearance:none;touch-action:manipulation;border-radius:3px}
.btn-primary{
  display:block;width:100%;border:none;padding:14px;
  font-size:16px;letter-spacing:3px;font-weight:700;text-transform:uppercase;
  margin-top:10px;min-height:50px;color:#000;background:var(--Y);
  box-shadow:0 4px 26px rgba(255,230,0,.32);
  transition:transform .15s,opacity .15s;
}
.btn-primary:active{transform:scale(.98);opacity:.9}
.btn-sm{
  background:transparent;border:1px solid var(--b2);
  color:var(--t2);font-family:var(--mono);font-size:9px;letter-spacing:1px;
  padding:6px 12px;min-height:32px;transition:all .15s;
}
.btn-sm:active{border-color:var(--Y);color:var(--Y)}
.btn-ghost{
  display:block;width:100%;background:transparent;border:1px solid var(--b1);
  color:var(--t3);font-family:var(--mono);font-size:9px;letter-spacing:2px;
  padding:12px;margin-top:8px;min-height:44px;text-transform:uppercase;
}

/* â”€â”€ KEY BAR â”€â”€ */
.key-bar{
  display:flex;justify-content:space-between;align-items:center;
  background:rgba(57,255,136,.05);border:1px solid rgba(57,255,136,.18);
  border-radius:3px;padding:10px 16px;margin-bottom:10px;
  font-family:var(--mono);font-size:10px;color:var(--G);
}
.key-dot{
  display:inline-block;width:6px;height:6px;border-radius:50%;
  background:var(--G);margin-right:8px;box-shadow:0 0 8px var(--G);
  animation:blink 2s ease-in-out infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}

/* â”€â”€ LEAGUE SECTIONS â”€â”€ */
.lg-section-hdr{
  font-family:var(--mono);font-size:9px;letter-spacing:3px;
  color:var(--Y);text-transform:uppercase;
  padding:14px 0 8px;border-bottom:1px solid rgba(255,230,0,.15);margin-bottom:7px;
}
.league-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:5px;margin-bottom:5px}
@media(min-width:460px){.league-grid{grid-template-columns:repeat(3,1fr)}}
.league-btn{
  background:rgba(255,255,255,.03);border:1px solid var(--b1);
  padding:10px;text-align:left;
  display:flex;flex-direction:column;gap:2px;min-height:50px;
  transition:all .15s;border-radius:3px;
}
.league-btn:active{transform:scale(.97)}
.league-btn.active{background:rgba(255,230,0,.08);border-color:rgba(255,230,0,.4)}
.lg-name{font-size:12px;font-weight:700;color:var(--W);line-height:1.2;letter-spacing:.3px}
.lg-sub{font-family:var(--mono);font-size:8px;color:var(--t3);margin-top:2px;letter-spacing:.5px}
.league-btn.active .lg-name{color:var(--Y)}

/* â”€â”€ DATE ROW â”€â”€ */
.date-row{display:flex;gap:6px;align-items:stretch}
.date-row input{flex:1;min-width:0}
.btn-arr{
  background:rgba(255,255,255,.04);border:1px solid var(--b1);
  color:var(--t2);width:44px;min-height:46px;
  display:flex;align-items:center;justify-content:center;font-size:14px;
  transition:all .15s;
}
.btn-arr:active{background:rgba(255,230,0,.1);color:var(--Y);border-color:rgba(255,230,0,.3)}
.btn-load{
  background:var(--B2);color:#fff;border:none;
  padding:0 16px;font-family:var(--mono);font-size:11px;letter-spacing:2px;
  min-height:46px;flex-shrink:0;text-transform:uppercase;
  box-shadow:0 0 18px rgba(26,159,255,.3);transition:opacity .15s;
}
.btn-load:active{opacity:.8}

/* â”€â”€ MESSAGES â”€â”€ */
.msg-loading{
  text-align:center;font-family:var(--mono);color:var(--Y);
  font-size:11px;letter-spacing:3px;padding:28px;text-transform:uppercase;
}
.scan-wrap{width:140px;overflow:hidden;margin:12px auto 0;height:2px;position:relative}
.scan-line{
  position:absolute;top:0;left:0;width:60%;height:100%;
  background:linear-gradient(90deg,transparent,var(--Y),transparent);
  animation:scan 1.4s ease-in-out infinite;
}
@keyframes scan{0%{left:-60%}100%{left:100%}}

.msg-empty{
  text-align:center;font-family:var(--mono);
  color:var(--t3);font-size:11px;padding:28px;letter-spacing:2px;text-transform:uppercase;
}

/* â”€â”€ ERROR / DEBUG â”€â”€ */
.err-box{padding:14px;background:rgba(255,64,64,.05);border:1px solid rgba(255,64,64,.2);margin-bottom:10px;border-radius:3px}
.err-title{font-family:var(--mono);color:var(--R);font-size:10px;letter-spacing:2px;margin-bottom:8px}
.err-body{color:rgba(255,150,150,.9);font-size:12px;line-height:1.6;font-family:var(--mono);word-break:break-all}
.err-hint{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,64,64,.1);color:var(--t3);font-family:var(--mono);font-size:10px;line-height:1.6}

.dbg-box{
  padding:12px 14px;background:rgba(255,230,0,.04);
  border:1px solid rgba(255,230,0,.15);margin-bottom:10px;border-radius:3px;
  font-family:var(--mono);font-size:10px;color:var(--t3);line-height:1.7;
}
.dbg-box b{color:var(--Y)}
.dbg-box .dbg-raw{
  margin-top:8px;padding:8px;background:rgba(0,0,0,.5);
  border-radius:2px;font-size:9px;color:var(--t2);
  word-break:break-all;white-space:pre-wrap;max-height:120px;overflow-y:auto;
}

.test-result{margin-top:10px;padding:10px 14px;font-size:11px;line-height:1.6;border:1px solid;border-radius:3px;font-family:var(--mono)}
.test-ok{border-color:rgba(57,255,136,.25);color:var(--G);background:rgba(57,255,136,.04)}
.test-fail{border-color:rgba(255,64,64,.3);color:var(--R);background:rgba(255,64,64,.04)}

/* â”€â”€ FIXTURE LIST â”€â”€ */
.fx-list{display:flex;flex-direction:column;gap:5px}
.fx-row{
  padding:12px 14px;background:rgba(255,255,255,.03);
  border:1px solid var(--b1);border-radius:3px;
  cursor:pointer;transition:all .15s;position:relative;overflow:hidden;
}
.fx-row::before{
  content:'';position:absolute;top:0;left:0;bottom:0;width:2px;
  background:var(--B);transform:scaleY(0);transition:transform .2s;
}
.fx-row.active{background:rgba(77,184,255,.07);border-color:rgba(77,184,255,.35)}
.fx-row.active::before{transform:scaleY(1)}
.fx-row:active{transform:scale(.995)}
.fx-teams{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:7px}
.fx-team{display:flex;align-items:center;gap:7px;flex:1;min-width:0}
.fx-team.r{justify-content:flex-end}
.fx-team img{width:22px;height:22px;object-fit:contain;flex-shrink:0}
.fx-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--W);letter-spacing:.3px}
.fx-score{
  font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--Y);
  padding:2px 10px;background:rgba(255,230,0,.06);
  border:1px solid rgba(255,230,0,.15);flex-shrink:0;letter-spacing:2px;border-radius:3px;
}
.fx-meta{display:flex;justify-content:space-between;align-items:center}
.fx-status{font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:2px 8px;border-radius:2px}
.fx-cta{font-family:var(--mono);font-size:9px;color:var(--B);letter-spacing:1px}
.fx-busy{font-family:var(--mono);font-size:9px;color:var(--O);letter-spacing:1px}

/* â”€â”€ RESULT â”€â”€ */
.match-banner{
  border-radius:3px;padding:22px 18px;margin-bottom:10px;
  background:var(--s1);border:1px solid var(--b1);position:relative;overflow:hidden;
}
.match-banner::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,230,0,.4),transparent);
}
.banner-inner{display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1}
.t-side{display:flex;flex-direction:column;gap:6px;flex:1}
.t-side.r{align-items:flex-end}
.t-logo{width:52px;height:52px;object-fit:contain;filter:drop-shadow(0 4px 12px rgba(0,0,0,.8))}
.t-name{font-size:14px;font-weight:700;line-height:1.2;color:var(--W);letter-spacing:.5px}
.t-tag{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--t3)}
.vs-wrap{display:flex;flex-direction:column;align-items:center;gap:4px;padding:0 12px;flex-shrink:0}
.vs-txt{font-family:'Bebas Neue',sans-serif;font-size:22px;color:rgba(255,230,0,.2);letter-spacing:3px}
.match-dt{font-family:var(--mono);font-size:9px;color:var(--B);letter-spacing:.5px;white-space:nowrap}

.pred-box{
  border-radius:3px;padding:26px 18px;margin-bottom:10px;text-align:center;
  background:var(--s1);border:1px solid var(--b1);position:relative;overflow:hidden;
}
.pred-box::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,230,0,.5),transparent);
}
.pred-eye{font-family:var(--mono);font-size:9px;letter-spacing:4px;color:var(--t3);margin-bottom:12px;text-transform:uppercase}
.pred-out{
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(40px,10vw,58px);letter-spacing:5px;line-height:1;
  color:var(--Y);text-shadow:0 0 50px rgba(255,230,0,.4);margin-bottom:14px;
}
.conf-pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 16px;border-radius:3px;
  font-family:var(--mono);font-size:10px;border:1px solid;letter-spacing:1px;
}
.conf-dot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0;animation:blink 2s ease-in-out infinite}

.prob-sec{background:var(--s1);border:1px solid var(--b1);border-radius:3px;padding:18px;margin-bottom:10px}
.prob-title{font-family:var(--mono);font-size:9px;letter-spacing:3px;color:var(--t3);margin-bottom:14px;text-transform:uppercase}
.prob-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.prob-row:last-child{margin-bottom:0}
.prob-lbl{width:70px;font-family:var(--mono);font-size:9px;letter-spacing:1px;color:var(--t2);flex-shrink:0;text-transform:uppercase}
.bar-track{flex:1;height:7px;background:rgba(255,255,255,.05);overflow:hidden;border-radius:2px}
.bar-fill{height:100%;border-radius:2px;transition:width 1.4s cubic-bezier(.25,1,.5,1)}
.prob-pct{width:44px;text-align:right;font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:1px;flex-shrink:0}

.xg-row{display:flex;gap:8px;margin-bottom:10px}
.xg-card{flex:1;background:var(--s1);border:1px solid var(--b1);border-radius:3px;padding:14px;text-align:center;position:relative;overflow:hidden}
.xg-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px}
.xg-h::before{background:linear-gradient(90deg,transparent,rgba(77,184,255,.5),transparent)}
.xg-a::before{background:linear-gradient(90deg,transparent,rgba(255,154,31,.5),transparent)}
.xg-lbl{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--t3);margin-bottom:4px;text-transform:uppercase}
.xg-val{font-size:36px;font-family:'Bebas Neue',sans-serif;letter-spacing:2px}

.form-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
@media(min-width:520px){.form-grid{flex-direction:row}}
.form-card{flex:1;background:var(--s1);border:1px solid var(--b1);border-radius:3px;padding:14px}
.form-head{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.form-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0}
.form-ttl{font-size:11px;font-weight:700;color:var(--W);letter-spacing:.5px}
.stat-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.05)}
.stat-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.stat-l{color:var(--t3);font-family:var(--mono);font-size:10px;letter-spacing:.5px}
.stat-v{font-weight:700;color:var(--Y);font-size:14px;font-family:'Bebas Neue',sans-serif;letter-spacing:1px}
.model-note{font-family:var(--mono);font-size:8px;letter-spacing:1px;color:var(--t3);text-align:center;padding:6px;text-transform:uppercase}

.install-hint{
  background:rgba(77,184,255,.05);border:1px solid rgba(77,184,255,.15);
  border-radius:3px;padding:10px 14px;margin-bottom:14px;
  font-family:var(--mono);font-size:9px;color:var(--t3);line-height:1.7;text-align:center;letter-spacing:1px;
}
.install-hint strong{color:var(--Y)}

.hidden{display:none!important}
@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
.up{animation:up .3s cubic-bezier(.25,1,.5,1) both}
.up2{animation:up .3s .05s cubic-bezier(.25,1,.5,1) both}
.up3{animation:up .3s .10s cubic-bezier(.25,1,.5,1) both}
.up4{animation:up .3s .15s cubic-bezier(.25,1,.5,1) both}
.up5{animation:up .3s .20s cubic-bezier(.25,1,.5,1) both}
</style>
</head>
<body>
<div class="topline"></div>
<div class="wrap">

<div class="install-hint" id="install-hint">
  ðŸ“± <strong>Add to Home Screen</strong> Â· tap Share in Safari â†’ "Add to Home Screen"
</div>

<header>
  <div class="hline"></div>
  <div class="logo-row">
    <div class="logo-icon">âš½</div>
    <span class="site-title">Match Oracle</span>
  </div>
  <p class="tagline">Poisson<span class="sep">â—†</span>Venue Form<span class="sep">â—†</span>Last 5 Games</p>
</header>

<!-- KEY -->
<div id="key-section" class="card">
  <span class="slabel">API-Football Key</span>
  <input type="password" id="api-key-input" placeholder="Paste your API key here"
    autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"/>
  <button class="btn-primary" id="save-key-btn">Unlock Match Oracle</button>
  <button class="btn-ghost hidden" id="test-btn">Test Connection</button>
  <div id="test-result" class="hidden"></div>
</div>

<div id="key-bar" class="key-bar hidden">
  <span><span class="key-dot"></span>Connected Â· API Key Active</span>
  <button class="btn-sm" id="change-key-btn">Change Key</button>
</div>

<!-- LEAGUE -->
<div id="league-section" class="card hidden">
  <span class="slabel">Select League</span>
  <div id="league-grid"></div>
</div>

<!-- DATE -->
<div id="date-section" class="card hidden">
  <span class="slabel">Select Date</span>
  <div class="date-row">
    <button class="btn-arr" id="prev-day">&#9664;</button>
    <input type="date" id="date-input"/>
    <button class="btn-arr" id="next-day">&#9654;</button>
    <button class="btn-load" id="load-btn">Load</button>
  </div>
</div>

<!-- LOADING -->
<div id="list-loading" class="msg-loading hidden">
  Fetching Fixtures
  <div class="scan-wrap"><div class="scan-line"></div></div>
</div>

<!-- ERROR -->
<div id="list-error" class="err-box hidden">
  <div class="err-title">&#9888; API Error</div>
  <div class="err-body" id="list-error-body"></div>
  <div class="err-hint" id="list-error-hint"></div>
</div>

<!-- DEBUG (shows when 0 results returned) -->
<div id="dbg-box" class="dbg-box hidden"></div>

<!-- EMPTY -->
<div id="list-empty" class="msg-empty hidden">&#8212; No fixtures found for this date &#8212;</div>

<!-- FIXTURE CARD -->
<div id="fixture-card" class="card hidden">
  <span class="slabel" id="fx-label">Fixtures</span>
  <div class="fx-list" id="fx-list"></div>
</div>

<!-- PRED ERROR -->
<div id="pred-error" class="err-box hidden">
  <div class="err-title">&#9888; Prediction Failed</div>
  <div class="err-body" id="pred-error-body"></div>
</div>

<!-- RESULT -->
<div id="result-section" class="hidden"></div>

</div><!-- /wrap -->

<script>
/* ============================================================
   STATE
============================================================ */
var API_KEY = '';
var selectedLeague = null;
var activeFixId = null;
var predicting = false;

/* ============================================================
   LEAGUES
   season = year the season STARTED (not calendar year)
   PL 2024/25 => season:2024  âœ“
   MLS 2025   => season:2025  âœ“
============================================================ */
var LEAGUE_GROUPS = [
  { title:'ENG Â· English Leagues', leagues:[
    {id:39,  name:'Premier League',  sub:'England',     season:2024},
    {id:40,  name:'Championship',    sub:'England',     season:2024},
    {id:41,  name:'League One',      sub:'England',     season:2024},
    {id:42,  name:'League Two',      sub:'England',     season:2024},
    {id:43,  name:'National League', sub:'England',     season:2024},
  ]},
  { title:'GER Â· German Leagues', leagues:[
    {id:78,  name:'Bundesliga',      sub:'Germany',     season:2024},
    {id:79,  name:'2. Bundesliga',   sub:'Germany',     season:2024},
    {id:80,  name:'3. Liga',         sub:'Germany',     season:2024},
  ]},
  { title:'NED Â· Dutch Leagues', leagues:[
    {id:88,  name:'Eredivisie',      sub:'Netherlands', season:2024},
    {id:89,  name:'Eerste Divisie',  sub:'Netherlands', season:2024},
  ]},
  { title:'NOR Â· Norwegian Leagues', leagues:[
    {id:103, name:'Eliteserien',     sub:'Norway',      season:2025},
    {id:104, name:'1. divisjon',     sub:'Norway',      season:2025},
  ]},
  { title:'EUR Â· Top European', leagues:[
    {id:140, name:'La Liga',         sub:'Spain',       season:2024},
    {id:135, name:'Serie A',         sub:'Italy',       season:2024},
    {id:61,  name:'Ligue 1',         sub:'France',      season:2024},
    {id:94,  name:'Primeira Liga',   sub:'Portugal',    season:2024},
    {id:203, name:'Sper Lig',        sub:'Turkey',      season:2024},
    {id:113, name:'Allsvenskan',     sub:'Sweden',      season:2025},
    {id:119, name:'Superliga',       sub:'Denmark',     season:2024},
  ]},
  { title:'UCL Â· European Cups', leagues:[
    {id:2,   name:'Champions Lge',   sub:'Europe',      season:2024},
    {id:3,   name:'Europa League',   sub:'Europe',      season:2024},
    {id:848, name:'Conference Lge',  sub:'Europe',      season:2024},
  ]},
  { title:'USA Â· North America', leagues:[
    {id:253, name:'MLS',             sub:'USA',         season:2025},
    {id:262, name:'Liga MX',         sub:'Mexico',      season:2024},
  ]},
];

/* ============================================================
   HELPERS
============================================================ */
function el(id){ return document.getElementById(id); }
function show(id){ var e=el(id); if(e) e.classList.remove('hidden'); }
function hide(id){ var e=el(id); if(e) e.classList.add('hidden'); }
function pad(n){ return String(n).padStart(2,'0'); }
function todayStr(){
  var d=new Date();
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ============================================================
   RAW API CALL
   Returns the full parsed JSON object so callers can inspect
   data.response, data.results, data.errors etc.
============================================================ */
function rawFetch(endpoint, params){
  var url = new URL('https://v3.football.api-sports.io' + endpoint);
  Object.keys(params).forEach(function(k){
    url.searchParams.set(k, String(params[k]));
  });
  return fetch(url.toString(), {
    method:'GET',
    headers:{
      'x-apisports-key': API_KEY,
      'x-rapidapi-key':  API_KEY,
      'x-rapidapi-host': 'v3.football.api-sports.io'
    }
  })
  .then(function(res){
    return res.json().then(function(json){
      json.__httpStatus = res.status;
      return json;
    });
  });
}

/* ============================================================
   KEY
============================================================ */
function saveKey(){
  var k = el('api-key-input').value.trim();
  if(!k){ alert('Please paste your API key first.'); return; }
  API_KEY = k;
  try{ localStorage.setItem('mo_key', k); }catch(e){}
  activateApp();
}
function activateApp(){
  hide('key-section');
  show('key-bar');
  show('league-section');
  buildLeagueGrid();
}
function changeKey(){
  API_KEY = ''; selectedLeague = null;
  try{ localStorage.removeItem('mo_key'); }catch(e){}
  ['key-bar','league-section','date-section','list-loading','list-error',
   'list-empty','dbg-box','fixture-card','result-section','pred-error'].forEach(hide);
  el('api-key-input').value = '';
  show('key-section');
}

/* ============================================================
   LEAGUE GRID
============================================================ */
function buildLeagueGrid(){
  var c = el('league-grid');
  c.innerHTML = '';
  LEAGUE_GROUPS.forEach(function(g){
    var hdr = document.createElement('div');
    hdr.className = 'lg-section-hdr';
    hdr.textContent = g.title;
    c.appendChild(hdr);
    var grid = document.createElement('div');
    grid.className = 'league-grid';
    g.leagues.forEach(function(lg){
      var btn = document.createElement('button');
      btn.className = 'league-btn';
      btn.innerHTML =
        '<span class="lg-name">'+esc(lg.name)+'</span>'+
        '<span class="lg-sub">'+esc(lg.sub)+' Â· '+lg.season+'</span>';
      btn.addEventListener('click', function(){
        document.querySelectorAll('.league-btn').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        selectedLeague = lg;
        show('date-section');
        if(!el('date-input').value) el('date-input').value = todayStr();
        loadFixtures();
      });
      grid.appendChild(btn);
    });
    c.appendChild(grid);
  });
}

/* ============================================================
   DATE NAV
============================================================ */
function shiftDate(days){
  var val = el('date-input').value || todayStr();
  var p = val.split('-');
  var d = new Date(+p[0], +p[1]-1, +p[2]+days);
  el('date-input').value = d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
  loadFixtures();
}

/* ============================================================
   LOAD FIXTURES
   Strategy: try season=N first. If 0 results, auto-retry
   with season=N-1 and season=N+1 to catch edge cases.
============================================================ */
function loadFixtures(){
  if(!selectedLeague) return;
  var date = el('date-input').value || todayStr();

  ['list-error','list-empty','dbg-box','fixture-card',
   'result-section','pred-error'].forEach(hide);
  show('list-loading');
  activeFixId = null;

  var lg = selectedLeague;

  // Try primary season first, then fallbacks
  tryLoadSeason(lg, lg.season, date)
    .then(function(result){
      if(result.fixtures.length > 0){
        return result;
      }
      // Primary returned 0 â€” try adjacent seasons silently
      var s1 = lg.season + 1;
      var s2 = lg.season - 1;
      return tryLoadSeason(lg, s1, date).then(function(r1){
        if(r1.fixtures.length > 0) return r1;
        return tryLoadSeason(lg, s2, date).then(function(r2){
          if(r2.fixtures.length > 0) return r2;
          // All returned 0 â€” return original result with debug info
          result.triedSeasons = [lg.season, s1, s2];
          result.rawResponses = [result.rawJson, r1.rawJson, r2.rawJson];
          return result;
        });
      });
    })
    .then(function(result){
      hide('list-loading');

      if(!result.fixtures.length){
        // Show debug info
        var dbg = el('dbg-box');
        var tried = result.triedSeasons ? result.triedSeasons.join(', ') : lg.season;
        var rawPreview = '';
        if(result.rawJson){
          try{ rawPreview = JSON.stringify(result.rawJson, null, 2).slice(0, 600); }catch(e){}
        }
        dbg.innerHTML =
          '<b>Zero fixtures returned</b><br>'+
          'League ID: <b>'+lg.id+'</b> &nbsp;|&nbsp; Seasons tried: <b>'+tried+'</b> &nbsp;|&nbsp; Date: <b>'+date+'</b><br>'+
          (result.rawJson && result.rawJson.results !== undefined
            ? 'API results field: <b>'+result.rawJson.results+'</b><br>' : '')+
          (result.rawJson && result.rawJson.errors && Object.keys(result.rawJson.errors).length
            ? 'Errors: <b>'+JSON.stringify(result.rawJson.errors)+'</b><br>' : '')+
          '<span style="color:#aaa">Possible reasons: no match on this date, wrong season, free plan limit, or league on break.</span>'+
          (rawPreview ? '<div class="dbg-raw">'+esc(rawPreview)+'</div>' : '');
        show('dbg-box');
        show('list-empty');
        return;
      }

      // Sort by kick-off
      var fixtures = result.fixtures;
      fixtures.sort(function(a,b){
        return new Date(a.fixture.date) - new Date(b.fixture.date);
      });

      el('fx-label').textContent =
        fixtures.length + ' Fixture' + (fixtures.length!==1?'s':'') +
        ' Â· ' + lg.name + ' Â· ' + date +
        (result.season !== lg.season ? ' (season '+result.season+')' : '');

      renderFixtureList(fixtures);
    })
    .catch(function(err){
      hide('list-loading');
      el('list-error-body').textContent = err.message || String(err);
      el('list-error-hint').innerHTML = (err.hint||'').replace(/\n/g,'<br>');
      show('list-error');
    });
}

function tryLoadSeason(lg, season, date){
  return rawFetch('/fixtures', {
    league: lg.id,
    season: season,
    date:   date
  })
  .then(function(json){
    // Check for hard errors
    if(json.__httpStatus === 401 || json.__httpStatus === 403){
      throw { message:'Invalid or expired API key (HTTP '+json.__httpStatus+')', hint:'Check your key at api-football.com' };
    }
    if(json.errors){
      var errs = typeof json.errors === 'object' ? Object.values(json.errors).filter(Boolean) : [];
      if(errs.length) throw { message:'API error: '+errs.join(' | '), hint:'Check your key and subscription plan.' };
    }
    var fixtures = Array.isArray(json.response) ? json.response : [];
    return { fixtures: fixtures, season: season, rawJson: json };
  });
}

function renderFixtureList(fixtures){
  var list = el('fx-list');
  list.innerHTML = '';
  fixtures.forEach(function(f){
    var sb = statusBadge(f);
    var gH = f.goals && f.goals.home !== null ? f.goals.home : null;
    var gA = f.goals && f.goals.away !== null ? f.goals.away : null;
    var sc = (gH !== null && gA !== null) ? gH + ' - ' + gA : 'vs';
    var row = document.createElement('div');
    row.className = 'fx-row';
    row.id = 'fx-' + f.fixture.id;
    row.innerHTML =
      '<div class="fx-teams">'+
        '<div class="fx-team">'+
          (f.teams.home.logo ? '<img src="'+esc(f.teams.home.logo)+'" alt="" loading="lazy" onerror="this.style.display=\'none\'">' : '')+
          '<span class="fx-name">'+esc(f.teams.home.name)+'</span>'+
        '</div>'+
        '<div class="fx-score">'+esc(sc)+'</div>'+
        '<div class="fx-team r">'+
          '<span class="fx-name">'+esc(f.teams.away.name)+'</span>'+
          (f.teams.away.logo ? '<img src="'+esc(f.teams.away.logo)+'" alt="" loading="lazy" onerror="this.style.display=\'none\'">' : '')+
        '</div>'+
      '</div>'+
      '<div class="fx-meta">'+
        '<span class="fx-status" style="color:'+sb.color+';background:'+sb.color+'18">'+esc(sb.text)+'</span>'+
        '<span class="fx-cta" id="cta-'+f.fixture.id+'">Predict &#9656;</span>'+
      '</div>';
    row.addEventListener('click', function(){ if(!predicting) predictFixture(f); });
    list.appendChild(row);
  });
  show('fixture-card');
}

/* ============================================================
   PREDICT
============================================================ */
function predictFixture(f){
  hide('pred-error'); hide('result-section');
  predicting = true;
  if(activeFixId){
    var old = el('fx-' + activeFixId);
    if(old) old.classList.remove('active');
  }
  activeFixId = f.fixture.id;
  var row = el('fx-' + f.fixture.id);
  if(row) row.classList.add('active');

  var ht = f.teams.home;
  var at = f.teams.away;
  var season = (f.league && f.league.season) || selectedLeague.season;

  function cta(cls, msg){
    var c = el('cta-' + f.fixture.id);
    if(c){ c.className = cls; c.textContent = msg; }
  }
  cta('fx-busy', 'Loading...');

  Promise.all([
    rawFetch('/fixtures', { team:ht.id, season:season, last:20 }),
    rawFetch('/fixtures', { team:at.id, season:season, last:20 })
  ])
  .then(function(results){
    cta('fx-busy', 'Calculating...');
    var hRaw = Array.isArray(results[0].response) ? results[0].response : [];
    var aRaw = Array.isArray(results[1].response) ? results[1].response : [];

    var hm = extractForm(hRaw, ht.id, 'home');
    var am = extractForm(aRaw, at.id, 'away');
    if(!hm || hm.n < 3) hm = extractForm(hRaw, ht.id, 'all') || hm;
    if(!am || am.n < 3) am = extractForm(aRaw, at.id, 'all') || am;
    if(!hm || !am) throw { message:'Not enough match data for this fixture. Try later in the season.' };

    var L = buildLambdas(hm, am);
    var probs = calcProbs(L.hL, L.aL);
    var mx = Math.max(probs.home, probs.draw, probs.away);
    var predicted = mx===probs.home ? 'Home Win' : mx===probs.draw ? 'Draw' : 'Away Win';
    renderResult(f, ht, at, hm, am, probs, predicted, mx);
    cta('fx-cta', 'âœ“ Done');
  })
  .catch(function(e){
    el('pred-error-body').textContent = e.message || String(e);
    show('pred-error');
    cta('fx-cta', 'Predict');
  })
  .then(function(){ predicting = false; });
}

/* ============================================================
   MATHS
============================================================ */
function poissonPMF(l, k){
  if(l <= 0) return k===0 ? 1 : 0;
  var r = -l + k * Math.log(l);
  for(var i=1;i<=k;i++) r -= Math.log(i);
  return Math.exp(r);
}
function calcProbs(hL, aL){
  var h=0, d=0, a=0;
  for(var i=0;i<=8;i++){
    for(var j=0;j<=8;j++){
      var p = poissonPMF(hL,i) * poissonPMF(aL,j);
      if(i>j) h+=p; else if(i===j) d+=p; else a+=p;
    }
  }
  var t = h+d+a || 1;
  return { home:h/t*100, draw:d/t*100, away:a/t*100, hL:hL, aL:aL };
}
function extractForm(fixtures, teamId, venue){
  if(!fixtures || !fixtures.length) return null;
  var rel = [];
  for(var i=0; i<fixtures.length; i++){
    var f = fixtures[i];
    if(!f||!f.fixture||!f.teams||!f.goals) continue;
    var st = f.fixture.status && f.fixture.status.short;
    if(st!=='FT' && st!=='AET' && st!=='PEN') continue;
    var isH = f.teams.home && f.teams.home.id === teamId;
    var isA = f.teams.away && f.teams.away.id === teamId;
    if(venue==='home' && !isH) continue;
    if(venue==='away' && !isA) continue;
    if(venue==='all'  && !isH && !isA) continue;
    rel.push(f);
    if(rel.length===5) break;
  }
  if(!rel.length) return null;
  var gf=0, ga=0, pts=0, cs=0;
  rel.forEach(function(f){
    var ih = f.teams.home.id === teamId;
    var sc = ih ? (f.goals.home||0) : (f.goals.away||0);
    var cc = ih ? (f.goals.away||0) : (f.goals.home||0);
    var win = ih ? f.teams.home.winner : f.teams.away.winner;
    var los = ih ? f.teams.away.winner : f.teams.home.winner;
    gf+=sc; ga+=cc;
    if(win) pts+=3; else if(!los) pts+=1;
    if(cc===0) cs++;
  });
  var n = rel.length;
  return { avgGF:gf/n, avgGA:ga/n, ppg:pts/n, csRate:cs/n, n:n, venue:venue };
}
function buildLambdas(hm, am){
  var avg = 1.35;
  return {
    hL: Math.max(0.3, (hm.avgGF/avg) * (am.avgGA/avg) * avg * 1.1),
    aL: Math.max(0.3, (am.avgGF/avg) * (hm.avgGA/avg) * avg)
  };
}
function confidence(p){
  if(p>=70) return { label:'Strong Signal',  color:'#39ff88' };
  if(p>=55) return { label:'Good Edge',      color:'#ffe600' };
  if(p>=42) return { label:'Slight Edge',    color:'#ff9a1f' };
  return           { label:'Too Close',      color:'#ff4040' };
}
function statusBadge(f){
  var s = f.fixture.status.short, e = f.fixture.status.elapsed;
  if(['1H','2H','HT','ET','P'].indexOf(s)>-1) return {text:e?e+"' LIVE":'LIVE', color:'#39ff88'};
  if(s==='FT') return {text:'Full Time', color:'#555'};
  if(s==='NS'){
    var t = new Date(f.fixture.date);
    return {text:t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), color:'#4db8ff'};
  }
  return {text:s, color:'#ff9a1f'};
}

/* ============================================================
   RENDER RESULT
============================================================ */
function renderResult(fixture, ht, at, hm, am, probs, predicted, maxProb){
  var conf = confidence(maxProb);
  var dt = new Date(fixture.fixture.date).toLocaleDateString([],{weekday:'short',day:'numeric',month:'short'});
  var sec = el('result-section');

  sec.innerHTML =
    '<div class="match-banner up"><div class="banner-inner">'+
      '<div class="t-side">'+
        (ht.logo?'<img class="t-logo" src="'+esc(ht.logo)+'" alt="" onerror="this.style.display=\'none\'">':'')+
        '<span class="t-name">'+esc(ht.name)+'</span><span class="t-tag">HOME</span>'+
      '</div>'+
      '<div class="vs-wrap"><span class="vs-txt">VS</span><span class="match-dt">'+esc(dt)+'</span></div>'+
      '<div class="t-side r">'+
        (at.logo?'<img class="t-logo" src="'+esc(at.logo)+'" alt="" onerror="this.style.display=\'none\'">':'')+
        '<span class="t-name">'+esc(at.name)+'</span><span class="t-tag">AWAY</span>'+
      '</div>'+
    '</div></div>'+

    '<div class="pred-box up2">'+
      '<div class="pred-eye">PREDICTED OUTCOME</div>'+
      '<div class="pred-out">'+esc(predicted)+'</div>'+
      '<span class="conf-pill" style="color:'+conf.color+';border-color:'+conf.color+'44;background:'+conf.color+'0d">'+
        '<span class="conf-dot" style="background:'+conf.color+'"></span>'+
        esc(conf.label)+' &mdash; '+maxProb.toFixed(1)+'%'+
      '</span>'+
    '</div>'+

    '<div class="prob-sec up3">'+
      '<div class="prob-title">Win Probabilities</div>'+
      pBar('Home Win', probs.home, '#4db8ff')+
      pBar('Draw',     probs.draw, '#ffe600')+
      pBar('Away Win', probs.away, '#ff9a1f')+
    '</div>'+

    '<div class="xg-row up4">'+
      '<div class="xg-card xg-h"><div class="xg-lbl">Home xG</div><div class="xg-val" style="color:#4db8ff">'+probs.hL.toFixed(2)+'</div></div>'+
      '<div class="xg-card xg-a"><div class="xg-lbl">Away xG</div><div class="xg-val" style="color:#ff9a1f">'+probs.aL.toFixed(2)+'</div></div>'+
    '</div>'+

    '<div class="form-grid up5">'+
      fCard(ht.name+' Â· Last '+hm.n+(hm.venue==='home'?' Home':' Games'), hm, '#4db8ff')+
      fCard(at.name+' Â· Last '+am.n+(am.venue==='away'?' Away':' Games'), am, '#ff9a1f')+
    '</div>'+
    '<div class="model-note">Poisson Distribution Â· Home Advantage Ã—1.1 Â· Venue-Weighted Form</div>';

  show('result-section');
  setTimeout(function(){ sec.scrollIntoView({behavior:'smooth',block:'start'}); }, 60);
}

function pBar(lbl, pct, color){
  return '<div class="prob-row">'+
    '<span class="prob-lbl">'+esc(lbl)+'</span>'+
    '<div class="bar-track"><div class="bar-fill" style="width:'+pct.toFixed(1)+'%;background:linear-gradient(90deg,'+color+'55,'+color+')"></div></div>'+
    '<span class="prob-pct" style="color:'+color+'">'+pct.toFixed(1)+'</span>'+
  '</div>';
}
function fCard(title, m, color){
  return '<div class="form-card">'+
    '<div class="form-head">'+
      '<div class="form-dot" style="background:'+color+';box-shadow:0 0 8px '+color+'88"></div>'+
      '<span class="form-ttl">'+esc(title)+'</span>'+
    '</div>'+
    sRow('Goals / Game',          m.avgGF.toFixed(2))+
    sRow('Conceded / Game',       m.avgGA.toFixed(2))+
    sRow('Points / Game',         m.ppg.toFixed(2))+
    sRow('Clean Sheet Rate',      Math.round(m.csRate*100)+'%')+
  '</div>';
}
function sRow(l, v){
  return '<div class="stat-row"><span class="stat-l">'+esc(l)+'</span><span class="stat-v">'+esc(v)+'</span></div>';
}

/* ============================================================
   BOOT
============================================================ */
el('date-input').value = todayStr();
el('save-key-btn').addEventListener('click', saveKey);
el('change-key-btn').addEventListener('click', changeKey);
el('prev-day').addEventListener('click', function(){ shiftDate(-1); });
el('next-day').addEventListener('click', function(){ shiftDate(1); });
el('load-btn').addEventListener('click', loadFixtures);
el('api-key-input').addEventListener('keydown', function(e){ if(e.key==='Enter') saveKey(); });

el('test-btn').addEventListener('click', function(){
  var btn = el('test-btn');
  btn.textContent = 'Testing...'; btn.disabled = true;
  hide('test-result');
  rawFetch('/status', {}).then(function(json){
    var d = json.response || json;
    var plan = (d.subscription&&d.subscription.plan) || 'unknown';
    var used = (d.requests&&d.requests.current) || '?';
    var lim  = (d.requests&&d.requests.limit_day) || '?';
    el('test-result').className = 'test-result test-ok';
    el('test-result').innerHTML = '&#10003; Connected Â· Plan: '+esc(plan)+'<br>Requests today: '+used+' / '+lim;
    show('test-result');
  }).catch(function(e){
    el('test-result').className = 'test-result test-fail';
    el('test-result').innerHTML = '&#10007; '+(e.message||String(e))+'<br><small>'+(e.hint||'')+'</small>';
    show('test-result');
  }).then(function(){ btn.textContent='Test Connection'; btn.disabled=false; });
});

// Restore saved key
try{
  var saved = localStorage.getItem('mo_key');
  if(saved){ API_KEY = saved; activateApp(); }
}catch(e){}

// Hide install hint on desktop
if(!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) hide('install-hint');
</script>
</body>
</html>
